 <script>

  // create variables to hold products for when people make selection
  var partner_products_cart = [];
  var partner_products_menu = <%= @parter_products_menu.to_json.html_safe %>;
  var total_partner_products_amount = 0;
  var subtotal = 0;


$(function(){
    // remove menu rating cards that have alreay been rated by this customer
    (function() {
          var rated_items = <%= @rated_menu_items %>;
          $('.menu_card').filter(function(){
            return rated_items.indexOf($(this).data('menu-id')) > -1
          }).remove();
        })();


    // create hub map
    function create_hub_map () {

      map = new GMaps({
        div: '#hub_map',
        lat: 43.7,
        lng: 79.4
      });

      var addresses_to_display = <%= raw @address_to_show_on_dashboard.to_json %>

      var latlngbounds = new google.maps.LatLngBounds();

      addresses_to_display.forEach(function(a){
        GMaps.geocode({
          address: a.location,
          callback: function(results, status) {
            if (status == 'OK') {
              var latlng = results[0].geometry.location;
              latlngbounds.extend(latlng);
              map.setCenter(latlng.lat(), latlng.lng());
              var marker = map.addMarker({
                          lat: latlng.lat(),
                          lng: latlng.lng()
                        });
              <% if @show_pick_up_info_window %>
              var infowindow = new google.maps.InfoWindow({
                                    content: '<p>Hub hours: '+a.hours
                                });
              infowindow.open(map,marker);
              <% end %>
            }
          }
        });
      });

      var isDraggable = $(document).width() > 800 ? true : false; // If 

      map.setOptions({
        draggable: isDraggable,
        scrollwheel: false
      });
      map.setZoom(13);
      map.panToBounds(latlngbounds);

    };

    create_hub_map();


    // ajax with json only response

    var tracker = 0;
    function ajax_json_response() {
      $('.ajax_json_response_only').off('click').on('click',function(){
        event.preventDefault();
        tracker += 1;
        _this = $(this).clone();
        id = "temporarily_replaced_item_"+tracker;
        $(this).replaceWith("<span id='"+id+"'>Wait...</span>");
        
        $.ajax({
          url: $(this).attr('href'),
          type: $(this).data('ajax_method'),
          dataType: 'JSON'
        }).done(function(data){
            if(data.result == 'success') {
              alert_element = _this.data('message-target')
              $(alert_element).addClass('alert-success');
              $(alert_element).html(data.message);
              $(alert_element).removeClass('hidden');
              $('#'+id).replaceWith("Cancelled");
            } else {
              alert_element = _this.data('message-target')
              $(alert_element).addClass('alert-danger');
              $(alert_element).html(data.message);
              $(alert_element).removeClass('hidden');
              $('#'+id).replaceWith(_this);
              ajax_json_response();
            }
        });      
      });
    }

    ajax_json_response();

    //URL segment

      //retrieve
      var hash = (window.location.hash == "" || window.location.hash == "#_=_") ? "#dashboard" : window.location.hash;
      $('#main-nav a[href='+hash+']').tab("show");
      $(".nav-main").find(".highlight").removeClass("highlight");
      $('#main-nav li a[href='+hash+']').parent().addClass("highlight");

      //navigation amongst the tabs
      $('#main-nav a, .url_seg').off("click").on("click",function(){
        window.location.hash = $(this).attr("href");
        $(".nav-main").find(".highlight").removeClass("highlight");
        $(".nav-main").find('a[href="'+$(this).attr("href")+'"]').parent().addClass("highlight");
      });

    //check for unpaid invoices before allowing to resume
    var unpaid_invoices = <%= @number_of_failed_invoices %>
    if (unpaid_invoices > 0) {
      $('#resume_subscription_button').addClass("disabled");
      $('#subscription_change_alert').removeClass("hidden");
    };


    // general populate modal

    function pull_modal_listener() {
      $('.pull_modal').off('click').on('click',function(){
        event.preventDefault();
        $.ajax({
          url: $(this).attr('href'),
          type: 'GET',
          dataType: 'HTML'
        }).done(function(data){
            $('#generalModal .modal-content').html(data);
            $('#generalModal').modal({show:true});
            $("#generalModal").animate({
                scrollTop: 0
            }, 500);
            partner_product_popup_listener();
        });
      });
    }

    pull_modal_listener();

    // star rating

    $('.star_rating').raty({
      click: function() {
        $(this).parent().children('.submit_meal_rating').html("Submit rating");
        $(this).parent().children('.submit_meal_rating').removeClass('disabled');
      }
    });

    // submit menu selection

    $('#submit_meal_selection').off('click').on('click',function(){

      data = [
        {
          production_day:"<%= @display_production_day_1 %>",
          beef:$('#monday_beef_1_spinner').val(),
          pork:$('#monday_pork_1_spinner').val(),
          poultry:$('#monday_poultry_1_spinner').val(),
          green_1:$('#monday_green_1_1_spinner').val(),
          green_2:$('#monday_green_2_1_spinner').val()},
        {
          production_day:"<%= @display_production_day_2 %>",
          beef:$('#thursday_beef_1_spinner').val(),
          pork:$('#thursday_pork_1_spinner').val(),
          poultry:$('#thursday_poultry_1_spinner').val(),
          green_1:$('#thursday_green_1_1_spinner').val(),
          green_2:$('#thursday_green_2_1_spinner').val()}
        ];

  

      $.ajax({
        url: '<%= update_meal_choice_path %>',
        type: 'POST',
        dataType: 'JSON',
        data: {meal_selection: JSON.stringify(data)}
      }).done(function(data){
        if(data.status == "success") {
          $('#submit_meal_selection').html("Selection Saved");
          $('#submit_meal_selection').addClass('disabled');
          $('#unsaved_warning_meal_selection').addClass('hidden');
        } else {
          $('#errorModal .modal-body').html("Meal selection could not be saved - " + data.message);
          $('#errorModal').modal({show:true});
        }
      })      
    });

    // submit rating

    $('.submit_meal_rating').off('click').on('click',function(){
      var comment = $(this).parent().parent().find('textarea').val();
      var rating = $(this).parent().parent().find('.star_rating').raty('score');
      var menu_id = $(this).parent().parent().find('#menu_id').val();

      _this = $(this);

      $.ajax({
        url: '<%= submit_meal_rating_path %>',
        type: 'POST',
        dataType: 'JSON',
        data: {comment:comment, rating:rating, menu_id:menu_id}
      }).done(function(data){
        if (data.result) {
          var elm = _this.closest('.menu_card');
          if (elm.hasClass('fade_left')) {
            elm.addClass('fadeOutLeft');  
          } else if (elm.hasClass('fade_right')) {
            elm.addClass('fadeOutRight');  
          }
          elm.one('webkitAnimationEnd mozAnimationEnd MSAnimationEnd oanimationend animationend', function(){
            $(this).remove();
        });
        } else {
          alert("Rating could not be saved; "+data.message)
        }
      })

    });

    // check delivery 
    $('#delivery_request_form input').off("change").on("change", function(){
      $("#delivery_change_warning").removeClass("hidden");
    });

    // $('#delivery_request_form input').off("focusout").on("focusout",delivery_check);

    function delivery_check(){
            GMaps.geocode({
              address: $('#delivery_request_form #delivery_address').val()+", Toronto",
              callback: function(results, status) {
                if (status == 'OK') {
                  if (results.length > 1) {
                    var result_array = results.map(function(result){
                        return result.formatted_address+"<br>"
                      });
                  $('#address_match_warning strong').html("We found multiple matching locations. <i>Did you mean:</i><br>"+result_array.join(" "));
                  $('#address_match_warning').removeClass("hidden");
                  $("#delivery_request_form input:submit").addClass("disabled");
                  } else {
                    if (results[0].geometry.location_type == "APPROXIMATE") {
                      $('#address_match_warning strong').html("We could not locate your address. Please be more specific.");
                      $('#address_match_warning').removeClass("hidden");
                      $("#delivery_request_form input:submit").addClass("disabled");
                    } else {
                    var latlng = results[0].geometry.location;
                      if (contains_location(latlng)=="downtown") {
                        $('#address_match_warning strong').html("Note that the default delivery time is every <span class='text-danger-lt'>Monday and Thursday between 11am and 1pm</span> unless otherwise requested below.<br><br>If you live in a residence with a front desk, please make sure that your concierge can accept the delivery on your behalf, or will let our courier leave the food by your door (note that since you are in our downtown delivery zone, your meals will be in regular bags, not thermal-insulated bags. So if you cannot receive your meals during our default delivery time, please indicate below a better time for delivery) <br><br>If our courier cannot drop off the meals, they will return them to the hub, where you are welcome to pick up the meals yourself");
                        $('#address_match_warning').removeClass("hidden");
                        $("label[for='note']").html("Additional note (we cannot deliver after 5pm)")
                        $('#boundary').val("downtown");
                        if ($("#delivery_request_form #phone_number").val() != "" ){
                          $("#delivery_request_form input:submit").removeClass("disabled");
                        }
                      } else if (contains_location(latlng)=="gta") {
                        $('#boundary').val("GTA");
                        $('#address_match_warning strong').html("Your meals will be delivered between <span class='text-danger-lt'>10am and 3pm every Monday and Thursday in a thermal insulated bag</span>. Our couriers will call you when they arrive. <br><br>If you live in a residence with a front desk, please make sure that your concierge can accept the delivery on your behalf, or will let our courier leave the food by your door. <br><br>If you can, please return the insulated thermal bags and ice packs to our courier so we can reuse them and minimize waste");
                        $("label[for='note']").html("Additional note")
                        $('#address_match_warning').removeClass("hidden");
                        if ($("#delivery_request_form #phone_number").val() != "" ){
                          $("#delivery_request_form input:submit").removeClass("disabled");
                        }
                      } else {
                        $('#address_match_warning strong').html("Your location is outside of our delivery zone");
                        $('#address_match_warning').removeClass("hidden");
                        $("#delivery_request_form input:submit").addClass("disabled");                    
                      }
                    }
                  }
                } else {
                  $('#address_match_warning strong').html("Uh oh, something went wrong")
                }
              }
            });

        }

    function contains_location(loc) {

      var gmaps_boundary_path = []
      var coordinates = <%= raw @delivery_boundary_coordinates %>
      var gmaps_boundary_path_gta = []
      var coordinates_gta = <%= raw @delivery_boundary_coordinates_gta %>

      coordinates.forEach(function(coordinate){
        gmaps_boundary_path.push(new google.maps.LatLng(coordinate.lat, coordinate.lng))
      });
      var delivery_boundary_polygon = new google.maps.Polygon({
        paths: gmaps_boundary_path
      });

      coordinates_gta.forEach(function(coordinate){
        gmaps_boundary_path_gta.push(new google.maps.LatLng(coordinate.lat, coordinate.lng))
      });
      var delivery_boundary_polygon_gta = new google.maps.Polygon({
        paths: gmaps_boundary_path_gta
      });

      if (google.maps.geometry.poly.containsLocation(loc, delivery_boundary_polygon)) {
        return 'downtown'
      } else if (google.maps.geometry.poly.containsLocation(loc, delivery_boundary_polygon_gta)) {
        return 'gta'
      } else {
        return false
      }
    }



    // autocomplete the address

    $('#delivery_address').geocomplete().bind("geocode:result", delivery_check);



    // date picker

    var earliest_resume_date = new Date(<%= @earliest_pause_end_date.year %>,<%= @earliest_pause_end_date.month.to_i - 1 %>,<%= @earliest_pause_end_date.day %>,0,0,0,0)
    var earliest_pause_start_date = new Date(<%= @earliest_pause_start_date.year %>,<%= @earliest_pause_start_date.month.to_i - 1 %>,<%= @earliest_pause_start_date.day %>,0,0,0,0)

    var pauseStartDate = $('#pause_date_start_picker').datepicker({
      format: "yyyy-mm-dd",
      onRender: function(date) {
        return (date.valueOf() < earliest_pause_start_date.valueOf() || date.getDay() != 1 ) ? 'disabled' : '';
      }
    }).on('changeDate', function() {
        // pauseDateValidate();
        var userSelectedPauseStartDate = new Date($('#pause_date_start_picker').val().split("-")[0],$('#pause_date_start_picker').val().split("-")[1]-1,$('#pause_date_start_picker').val().split("-")[2]);
        earliest_resume_date.setDate(userSelectedPauseStartDate.getDate() + 7);
        createResumeDatePicker ();
        $('#pause_date_start_picker').datepicker('hide');
      });

    $('#pause_date_start_picker').datepicker('setValue', earliest_pause_start_date);



    function createResumeDatePicker () {
      $('#pause_date_picker').datepicker({
        format: "yyyy-mm-dd",
        onRender: function(date) {
          return (date.valueOf() < earliest_resume_date.valueOf() || date.getDay() != 1) ? 'disabled' : '';
        }
      }).on('changeDate', function() {
          pauseDateValidate();
          $('#pause_date_picker').datepicker('hide');
        });

      var existingResumeDate = new Date($('#pause_date_picker').val().split("-")[0],$('#pause_date_picker').val().split("-")[1]-1,$('#pause_date_picker').val().split("-")[2]);

      existingResumeDate = (isNaN( existingResumeDate.getTime() )) ? new Date(1999,1,1) : existingResumeDate;

      var resumeDateToSet = new Date(Math.max.apply(null,[existingResumeDate,earliest_resume_date]))  //get the higher of earliest resume and existing

      $('#pause_date_picker').datepicker('setValue', resumeDateToSet);      
    

    }

    createResumeDatePicker ();

    // pause date validation
    // function pauseDateValidate() {
    
    $('#pause_date_picker').off("input").on("input",pauseDateValidate);
    // }

    function pauseDateValidate() {
      var userSelectedDate = new Date($('#pause_date_picker').val().split("-")[0],$('#pause_date_picker').val().split("-")[1]-1,$('#pause_date_picker').val().split("-")[2]);
      if (userSelectedDate.valueOf() < earliest_resume_date.valueOf()) {
        $("#pauseModal form input:submit").prop("disabled",true);
      } else {
        $("#pauseModal form input:submit").prop("disabled",false); 
      }
    };

    pauseDateValidate();



    // checkboxes for meal preferences
    var disable_sub_update = <%= @disable_sub_update %>;

    $('#no_beef, #no_pork, #no_poultry').off("change").on("change",function(){
      $('#subscription_change_warning').removeClass("hidden");
      if (disable_sub_update == false) {
          $('#change_meal_count input[type=submit]').removeClass("disabled");
        }
    });

    // meal selections pinner

    var monday_regular_limit = <%= @monday_regular.to_i %>;
    var monday_green_limit = <%= @monday_green.to_i %>;
    var thursday_regular_limit = <%= @thursday_regular.to_i %>;
    var thursday_green_limit = <%= @thursday_green.to_i %>;
    var monday_total_limit = monday_regular_limit + monday_green_limit;
    var thursday_total_limit = thursday_regular_limit + thursday_green_limit
    var updated_monday_regular_limit = <%= @monday_regular.to_i - @monday_beef_selection_1_number.to_i - @monday_pork_selection_1_number.to_i - @monday_poultry_selection_1_number.to_i %>;
    var updated_monday_green_limit = <%= @monday_green.to_i - @monday_green_1_selection_1_number.to_i - @monday_green_2_selection_1_number.to_i%>;
    var updated_monday_total_limit = updated_monday_regular_limit + updated_monday_green_limit;
    var updated_thursday_regular_limit = <%= @thursday_regular.to_i - @thursday_beef_selection_1_number.to_i - @thursday_pork_selection_1_number.to_i - @thursday_poultry_selection_1_number.to_i %>;
    var updated_thursday_green_limit = <%= @thursday_green.to_i - @thursday_green_1_selection_1_number.to_i - @thursday_green_2_selection_1_number.to_i%>;
    var updated_thursday_total_limit = updated_thursday_regular_limit + updated_thursday_green_limit;

    function update_display_guide() {

      if (updated_monday_total_limit == 0) {
        $('#monday_total_remaining_display').addClass('hidden');
        $('#monday_selection_full').removeClass('hidden');
      } else {
        $('#monday_total_remaining_display').removeClass('hidden');
        $('#monday_total_remaining').html(updated_monday_total_limit);
        $('#monday_selection_full').addClass('hidden');
      }

      if (updated_thursday_total_limit == 0) {
        $('#thursday_total_remaining_display').addClass('hidden');
        $('#thursday_selection_full').removeClass('hidden');
      } else {
        $('#thursday_total_remaining_display').removeClass('hidden');
        $('#thursday_total_remaining').html(updated_thursday_total_limit);
        $('#thursday_selection_full').addClass('hidden');
      }

    };

    update_display_guide();



    $('.partner_product_spinner').TouchSpin({
      min: 0,
      max: 3,
      step: 1
    });

    $('#monday_beef_1_spinner').TouchSpin({
      min: 0,
      max: Math.max($('#monday_beef_1_spinner').val()*1 + updated_monday_total_limit,$('#monday_beef_1_spinner').val()*1),
      step: 1
    });

    $('#monday_pork_1_spinner').TouchSpin({
      min: 0,
      max: Math.max($('#monday_pork_1_spinner').val()*1 + updated_monday_total_limit,$('#monday_pork_1_spinner').val()*1),
      step: 1
    });

    $('#monday_poultry_1_spinner').TouchSpin({
      min: 0,
      max: Math.max($('#monday_poultry_1_spinner').val()*1 + updated_monday_total_limit,$('#monday_poultry_1_spinner').val()*1),
      step: 1
    });

    $('#monday_green_1_1_spinner').TouchSpin({
      min: 0,
      max: Math.max($('#monday_green_1_1_spinner').val()*1 + updated_monday_total_limit,$('#monday_green_1_1_spinner').val()*1),
      step: 1
    });

    $('#monday_green_2_1_spinner').TouchSpin({
      min: 0,
      max: Math.max($('#monday_green_2_1_spinner').val()*1 + updated_monday_total_limit,$('#monday_green_2_1_spinner').val()*1),
      step: 1
    });

    $('#thursday_beef_1_spinner').TouchSpin({
      min: 0,
      max: Math.max($('#thursday_beef_1_spinner').val()*1 + updated_thursday_total_limit,$('#thursday_beef_1_spinner').val()*1),
      step: 1
    });

    $('#thursday_pork_1_spinner').TouchSpin({
      min: 0,
      max: Math.max($('#thursday_pork_1_spinner').val()*1 + updated_thursday_total_limit,$('#thursday_pork_1_spinner').val()*1),
      step: 1
    });

    $('#thursday_poultry_1_spinner').TouchSpin({
      min: 0,
      max: Math.max($('#thursday_poultry_1_spinner').val()*1 + updated_thursday_total_limit,$('#thursday_poultry_1_spinner').val()*1),
      step: 1
    });

    $('#thursday_green_1_1_spinner').TouchSpin({
      min: 0,
      max: Math.max($('#thursday_green_1_1_spinner').val()*1 + updated_thursday_total_limit,$('#thursday_green_1_1_spinner').val()*1),
      step: 1
    });

    $('#thursday_green_2_1_spinner').TouchSpin({
      min: 0,
      max: Math.max($('#thursday_green_2_1_spinner').val()*1 + updated_thursday_total_limit,$('#thursday_green_2_1_spinner').val()*1),
      step: 1
    });

    // marketplace 

    <% if @display_marketplace_to_customers %>

    function partner_product_popup_listener() {

      $('.add_to_cart_popup .qty').each(function(){
        var product_id = $(this).data('product-id');
        var matched_cart_item = partner_products_cart.filter(function(ci){return ci.product_id == product_id});
        if(matched_cart_item.length > 0) {
          $(this).val(matched_cart_item[0].quantity);
        }
        $(this).closest('form').find('input:submit').val('Update Cart');
      })

      $('.add_to_cart_popup .qty').val()

      $('.add_to_cart_popup').off("submit").on("submit",function(){
        event.preventDefault();
        var product_id_chosen = $(this).data("product-id");
        var quantity = $(this).find('.qty').val();
        update_partner_products_cart(product_id_chosen,quantity);
        $(this).find('input:submit').val('Update Cart');
        $('.add_to_cart').filter(function(){return $(this).data("product-id") == product_id_chosen}).find('input:submit').val('Update Cart')
      });
    }


    function partner_product_card_listener() {
      $('.add_to_cart').off("submit").on("submit",function(){
        event.preventDefault();
        var product_id_chosen = $(this).data("product-id");
        update_partner_products_cart(product_id_chosen,$(this).find('.qty').val());
        $(this).find('input:submit').val('Update Cart');
      });
    }

    partner_product_card_listener();

    function update_partner_products_cart (product_id, number) {
      var cart_item = partner_products_cart.filter(function(ci){return ci.product_id == product_id});
      if (cart_item.length == 0) {
        if (number <= 0) {

        } else {
          partner_products_cart.push({product_id:product_id,quantity:number});  
        }
      } else if (cart_item.length == 1) {
        if (number <= 0) {
          for (var i = 0; i < partner_products_cart.length; i++){
            if (partner_products_cart[i].product_id == product_id) { 
                partner_products_cart.splice(i, 1);
            }
          };          
        } else {
          cart_item[0].quantity = number;
        }
      } else { // if for some reason there are multiple entries of the same product in the cart, delete all the same products first and then add the product again
        for (var i = 0; i < partner_products_cart.length; i++){
          if (partner_products_cart[i].product_id == product_id) { 
              partner_products_cart.splice(i, 1);
          }
        };

        if (number <= 0) {

        } else {
          partner_products_cart.push({product_id:product_id,quantity:number});  
        }

      };

      update_total_and_subtotal();

      $('#partner_product_total_dollar').html((total_partner_products_amount.toFixed(2)/100.00).toFixed(2).toString());

      if (partner_products_cart.length == 0 ) {

        if ($('#submit_partner_product_selection').hasClass('disabled')) {
        } else {
          $('#submit_partner_product_selection').addClass('disabled');
        }
      
        if ($('#place_order').hasClass('disabled')) {
        } else {
          $('#place_order').addClass('disabled');
        }

      } else {

        if ($('#submit_partner_product_selection').hasClass('disabled')) {
        $('#submit_partner_product_selection').removeClass('disabled');
        }

        if ($('#place_order').hasClass('disabled')) {
        $('#place_order').removeClass('disabled');
        }
      }

      $('.qty*[data-product-id="'+product_id+'"]').val(number);

    };

    function update_total_and_subtotal() {
      total_partner_products_amount = 0;
      subtotal = 0;

      partner_products_cart.forEach(function(pp){total_partner_products_amount = total_partner_products_amount + parseInt(pp.quantity) * partner_products_menu.filter(function(i){return i.product_id == pp.product_id})[0].price });
      subtotal = total_partner_products_amount;
      total_partner_products_amount = Math.round(total_partner_products_amount * 1.13);
    }

    $('#submit_partner_product_selection').off('click').on('click',function(){
      
      $('#partner_products_checkout_summary tbody').empty();
      partner_products_cart.forEach(function(pp){
        if (pp.quantity == 0) {

        } 
        else {
        var product_info = partner_products_menu.filter(function(ppmi){return ppmi.product_id == pp.product_id})[0]
        var pp_id = pp.product_id;
        var pp_qty = pp.quantity;
        var pp_name = product_info.name;
        var pp_price = product_info.price;
        var total_price_before_hst = pp_qty * pp_price;
        $('#partner_products_checkout_summary tbody').append("<tr><td><input class='checkout_qty_input' data-product-id='"+pp_id+"' type='number' style='width:40px; text-align:center;' min='0' value='"+pp_qty+"'></input></td><td>"+pp_name+"</td><td>$"+(pp_price.toFixed(2)/100.00).toFixed(2).toString()+"</td><td class='total_item_price'>$"+(total_price_before_hst.toFixed(2)/100.00).toFixed(2).toString()+"</td></<tr>")
        }
      });

      $('#partner_products_checkout_summary tbody').append("<tr><td colspan='3' class='text-right'>Subtotal</td><td class='subtotal'>$"+(subtotal.toFixed(2)/100.00).toFixed(2).toString()+"</td></tr>");
      var hst = total_partner_products_amount - subtotal;
      $('#partner_products_checkout_summary tbody').append("<tr><td colspan='3' class='text-right'>HST</td><td class='hst'>$"+(hst.toFixed(2)/100.00).toFixed(2).toString()+"</td></tr>");
      $('#partner_products_checkout_summary tbody').append("<tr><td colspan='3' class='text-right'><b>Total</b></td><td><b class='total'>$"+(total_partner_products_amount.toFixed(2)/100.00).toFixed(2).toString()+"</b></td></tr>");
      $('#partner_product_cart_modal').modal({show:true});

      $('.checkout_qty_input').off('change').on('change',function(){
        var product_id = $(this).data('product-id');
        if ($(this).val() < 0 ) {
          $(this).val('0');
        } 
        var updated_qty_at_checkout = $(this).val();
        update_partner_products_cart (product_id, updated_qty_at_checkout);
        var product_info = partner_products_menu.filter(function(ppmi){return ppmi.product_id == product_id})[0];
        var product_price = product_info.price;
        var item_total_price_before_hst = updated_qty_at_checkout * product_price;
        update_total_and_subtotal();

        hst = total_partner_products_amount - subtotal;

        $(this).parent().parent().find('.total_item_price').html("$"+(item_total_price_before_hst.toFixed(2)/100.00).toFixed(2).toString());

        $(this).parent().parent().parent().find('.subtotal').html("$"+(subtotal.toFixed(2)/100.00).toFixed(2).toString());

        $(this).parent().parent().parent().find('.hst').html("$"+(hst.toFixed(2)/100.00).toFixed(2).toString());

        $(this).parent().parent().parent().find('.total').html("$"+(total_partner_products_amount.toFixed(2)/100.00).toFixed(2).toString());
        
      });

    });


    $('#place_order').off('click').on('click',function(){

      var _this = $(this);
      var submit_button_original_value = $(this).attr('value');
      var submit_button_width = $(this).outerWidth();

      $(this).css('width',submit_button_width).addClass('disabled').html('Wait...');

      $.ajax({
        url: $(this).attr('href'),
        type: 'POST',
        data: {cart: JSON.stringify(partner_products_cart)},
        dataType: 'JSON'
      }).done(function(data){
        if (data.result == 'success') {
          if ($('#partner_product_purchase_alert').hasClass('hidden')) {} else {$('#partner_product_purchase_alert').addClass('hidden')};
          $('#partner_product_cart_modal').modal('hide');
          $('#partner_product_success_alert').html(data.message).removeClass('hidden');
          _this.removeClass('disabled').html('Order');
          partner_products_cart = [];
          total_partner_products_amount = 0;
          subtotal = 0;
          $('#partner_product_total_dollar').html("$0.00");

        } else {
          if ($('#partner_product_success_alert').hasClass('hidden')) {} else {$('#partner_product_success_alert').addClass('hidden')};
          $('#partner_product_purchase_alert').html(data.message);
          $('#partner_product_purchase_alert').removeClass('alert-danger').removeClass('alert-success').addClass('alert-danger').removeClass('hidden');
          _this.removeClass('disabled').html('Order');
        }
      });

    });

    function add_listener_to_order_history() {
      $('#view_order_history').off("click").on("click",function(){
        event.preventDefault();

        $.ajax({
          url: $(this).attr('href'),
          type: 'GET',
          dataType: 'HTML'
        }).done(function(data){
          $('#order_history_table_container').html(data);
          ajax_json_response();
          $('#main-nav li a[href="#view_orders"]').tab('show');
          pull_modal_listener();
        })

      });
    }

    add_listener_to_order_history();


    <% end %>

    $('#monday_beef_1_spinner, #monday_pork_1_spinner, #monday_poultry_1_spinner, #monday_green_1_1_spinner, #monday_green_2_1_spinner, #thursday_beef_1_spinner, #thursday_pork_1_spinner, #thursday_poultry_1_spinner, #thursday_green_1_1_spinner, #thursday_green_2_1_spinner').off("change").on("change", function(){

      $(this).closest('.display_number_container').find('.selection_display').html($(this).val());
      updated_monday_regular_limit = monday_regular_limit -  $('#monday_beef_1_spinner').val() -  $('#monday_pork_1_spinner').val() -  $('#monday_poultry_1_spinner').val();


      updated_monday_green_limit = monday_green_limit -  $('#monday_green_1_1_spinner').val() -  $('#monday_green_2_1_spinner').val();
      updated_monday_total_limit = updated_monday_regular_limit + updated_monday_green_limit;
      updated_thursday_regular_limit = thursday_regular_limit -  $('#thursday_beef_1_spinner').val() -  $('#thursday_pork_1_spinner').val() -  $('#thursday_poultry_1_spinner').val();
      updated_thursday_green_limit = thursday_green_limit -  $('#thursday_green_1_1_spinner').val() -  $('#thursday_green_2_1_spinner').val();
      updated_thursday_total_limit = updated_thursday_regular_limit + updated_thursday_green_limit;


      $('#monday_beef_1_spinner, #monday_pork_1_spinner, #monday_poultry_1_spinner, #monday_green_1_1_spinner, #monday_green_2_1_spinner').not($(this)).each(function(){$(this).trigger("touchspin.updatesettings", {max: Math.max($(this).val()*1,updated_monday_total_limit + $(this).val()*1)})});


      $('#thursday_beef_1_spinner, #thursday_pork_1_spinner, #thursday_poultry_1_spinner, #thursday_green_1_1_spinner, #thursday_green_2_1_spinner').not($(this)).each(function(){$(this).trigger("touchspin.updatesettings", {max: Math.max($(this).val()*1,updated_thursday_total_limit + $(this).val()*1)})});


      if (updated_monday_total_limit == 0 && updated_thursday_total_limit == 0) {
        $('#submit_meal_selection').removeClass('disabled');  
      } else {
        $('#submit_meal_selection').addClass('disabled');  
      }
      
      $('#unsaved_warning_meal_selection').removeClass('hidden');

      update_display_guide();

    })


    // total meals spinner

    var total_meal_number = <%= @total_meals %>
    var updated_total_meal_number = total_meal_number
    var total_green = <%= @total_green %>
    var updated_green= total_green
                                                    
    $('#total_meals_spinner').TouchSpin({
      min: 6,
      max: 34,
      step: 2
    });

      
    $('#green_meals_spinner').TouchSpin({
        min: 0,
        max: updated_total_meal_number,
        step: 1
    });

    

    if (disable_sub_update == false) {

      $('#total_meals_spinner').off("change").on("change", function(){
        
        $('#subscription_change_warning').removeClass("hidden");

        if (disable_sub_update == false) {
          $('#change_meal_count input[type=submit]').removeClass("disabled");
        }

        var updated_value = $(this).val();


        if (updated_value - updated_green < 0) { 
            $('#monday_grn_hidden').val(updated_value/2);
            $('#thursday_grn_hidden').val(updated_value/2);
            updated_green = updated_value;          
            $('#monday_reg_hidden').val(0);
            $('#thursday_reg_hidden').val(0);  
            updated_total_meal_number = updated_value;
            $('#green_meals_spinner').val(updated_green);
            $('#green_meals_spinner').trigger("touchspin.updatesettings", {max: updated_total_meal_number});
         } else {
            $('#monday_reg_hidden').val(updated_value/2 - $('#monday_grn_hidden').val()*1)
            $('#thursday_reg_hidden').val(updated_value/2 - $('#thursday_grn_hidden').val()*1)

            updated_total_meal_number = updated_value;
            $('#green_meals_spinner').val(updated_green);
            $('#green_meals_spinner').trigger("touchspin.updatesettings", {max: updated_total_meal_number});
         
         }

         updateVisibleNumbers();
      });
                

      $('#green_meals_spinner').off("change").on("change",function(){
          $('#subscription_change_warning').removeClass("hidden");
          if (disable_sub_update == false) {
            $('#change_meal_count input[type=submit]').removeClass("disabled");
          }

          var updated_value = $(this).val();
          var daily_difference_low;
          var daily_difference_high;
          var updated_mon_reg;
          var updated_thu_reg;
          if ((updated_value - total_green) % 2 == 0) {
            daily_difference_low = (updated_value - total_green)/2;
            daily_difference_high = (updated_value - total_green)/2;
            updated_mon_grn = <%= @monday_green %> + daily_difference_low;
            updated_thu_grn = <%= @thursday_green %> + daily_difference_high;
            $('#monday_grn_hidden').val(updated_mon_grn);
            $('#thursday_grn_hidden').val(updated_thu_grn);
            updated_green = updated_value;

          } else {
            daily_difference_low = (updated_value - total_green)/2 - 0.5;
            daily_difference_high = (updated_value - total_green)/2 + 0.5;
            updated_mon_grn = <%= @monday_green %> + daily_difference_low;
            updated_thu_grn = <%= @thursday_green %> + daily_difference_high;
            $('#monday_grn_hidden').val(updated_mon_grn);
            $('#thursday_grn_hidden').val(updated_thu_grn);
            updated_green = updated_value;
          };

          $('#monday_reg_hidden').val(updated_total_meal_number/2 - updated_mon_grn);
          $('#thursday_reg_hidden').val(updated_total_meal_number/2 - updated_thu_grn)


          updateVisibleNumbers();
        });
      
      };

    function updateVisibleNumbers() {
      $('#disp_reg').html(parseInt($('#monday_reg_hidden').val())+parseInt($('#monday_grn_hidden').val())+parseInt($('#thursday_reg_hidden').val())+parseInt($('#thursday_grn_hidden').val()));
      $('#disp_grn').html(parseInt($('#monday_grn_hidden').val())+parseInt($('#thursday_grn_hidden').val()));
    };

    function pagination_listener() {
      $('.pagination a').off("click").on("click",function(){
        event.preventDefault();

        $.ajax({
          url: $(this).attr('href'),
          type: 'GET',
          dataType: 'script'
        }).done(function(data){
          pull_modal_listener();
          partner_product_card_listener();
          pagination_listener();
          add_listener_to_order_history();

          $('.add_to_cart input[type=number]').each(function(){
              var product_id = $(this).data('product-id');
              var product_in_cart = partner_products_cart.filter(function(ppc){return ppc.product_id == product_id});

              if (product_in_cart.length > 0) {
                  var quantity = product_in_cart[0].quantity;
                  $(this).val(quantity);
                  console.log($(this).parent().find('input[type=submit]'));
                  $(this).closest('form').find('input[type=submit]').val('Update Cart');
              }
          });

        });
      });
    }
    pagination_listener();
});

</script>


<section class="vbox">
    <header class="bg-black header header-md navbar-fixed-top-xs box-shadow">
        <div class="navbar-header aside-md">
            <a class="btn btn-link visible-xs m-t-sm" data-toggle="class:nav-off-screen" data-target="#nav">
                      <i class="fa fa-bars"></i>
            </a>
            <a href="#dashboard" data-toggle="tab" id="logo" class="url_seg">
              <%= image_tag "logo-light.png", width:"120px", alt: "Chowdy", class: "m-t-md m-b-sm" %>
            </a>
        </div>
      
    </header>    
    <section>
        <section class="hbox stretch">
            
            <aside class="bg-white aside-md hidden-print b-r" id="nav">
                <nav class="nav-primary hidden-xs padder-v tabbable">
                    <div class="visible-xs" style="height: 65px;"></div>
                    <ul class="nav nav-main" data-ride="collapse" id="main-nav">
                        <li class="highlight">
                          <a href="#dashboard" class="auto b-b padder-v" data-toggle="tab">
                            <i class="i i-statistics icon">
                            </i>
                            <span class="font-bold">Dashboard</span>
                          </a>
                        </li>
                        <% if @display_meal_selection %>
                        <li class="highlight">
                          <a href="#meal_selection" class="auto b-b padder-v" data-toggle="tab">
                            <i class="i i-book icon">
                            </i>
                            <span class="font-bold">Choose Meals</span>
                          </a>
                        </li>
                          <% if @display_marketplace_to_customers %>
                            <li class="highlight">
                              <a href="#partner_product_selection" class="auto b-b padder-v" data-toggle="tab">
                                <i class="fa fa-truck">
                                </i>
                                <span class="font-bold">Marketplace (new)</span>
                              </a>
                            </li>
                          <% end %>
                        <% end %>
                        <li>
                          <a href="#changePlan" class="b-b padder-v" data-toggle="tab">
                            <i class="i i-params icon">
                            </i>
                            <span class="font-bold">Manage Subscription</span>
                          </a>
                        </li>
                        <li>
                          <a href="#referral" class="b-b padder-v"  data-toggle="tab">
                            <i class="i i-users2 icon">
                            </i>
                            <span class="font-bold">Referral and Promo</span>
                          </a>
                        </li>
                        <li>
                          <a href="#delivery" class="b-b padder-v"  data-toggle="tab">
                            <i class="i i-paperplane icon">
                            </i>
                            <span class="font-bold">Delivery</span>
                          </a>
                        </li>
                        <li>
                          <a href="#settings" class="b-b padder-v" data-toggle="tab">
                            <i class="i i-settings icon">
                            </i>
                            <span class="font-bold">Settings</span>
                          </a>
                        </li>
                        <li>
                          <a href="#view_orders" class="b-b padder-v hidden" data-toggle="tab">
                            <i class="i i-settings icon">
                            </i>
                            <span class="font-bold"></span>
                          </a>
                        </li>
                        <li>
                          <%= link_to logout_path, class:"padder-v" do %>
                            <i class="fa fa-terminal">
                            </i>
                            <span class="font-bold">Log out</span>
                          <% end %>
                        </li>
                        <div class="text-center m-t-xl">If you have any questions,<br>visit our <a href="#help" class="text-primary" data-toggle="tab">help & support</a></div>
                        <a href="#rate_menu"  data-toggle="tab">
                          <div class="btn btn-s-md btn-warning m-t-lg m-l-md" style="width: 82%;">
                            <i class="fa fa-star">
                            </i>&nbsp;&nbsp;&nbsp;&nbsp;
                            Rate the meals
                          </div>
                        </a>
                    </ul>
                </nav>
                
            </aside>

            <section id="content container">
                <section class="hbox stretch bg-light tab-content">
                    <section class="tab-pane active" id="dashboard" role="tabpanel">
                        <section class="vbox">
                            <section class="scrollable padder">
                                <% if @number_of_failed_invoices > 0 %>
                                  <section class="row m-t-md">
                                    <div class="col-sm-12">
                                      <div class="alert alert-danger" style="margin-bottom:0 !important; font-size: 18px;">
                                        <i class="fa fa-ban-circle"></i>You have <strong><%= @number_of_failed_invoices %> overdue invoice </strong><%= "s" if @number_of_failed_invoices > 1 %> for the week<%= "s" if @number_of_failed_invoices > 1 %> of <%= @failed_weeks.to_sentence %> due to declined credit card. We will re-attempt in a few days. You can also<a href="#settings" data-toggle="tab" class="url_seg"> update your card</a> on your profile.
                                      </div>
                                    </div>
                                  </section>
                                <% end %>

                                <% unless @announcements.blank? %>
                                  <% @announcements.each do |announcement| %>
                                    <section class="row m-t-md">
                                      <div class="col-sm-12">
                                        <div class="alert alert-success" style="margin-bottom:0 !important; font-size: 18px;">
                                          <button type="button" class="close" data-dismiss="alert">×</button>
                                          <%= announcement.setting_value %>
                                        </div>
                                      </div>
                                    </section>
                                  <% end %>
                                <% end %>
                                
                                <% if @current_customer.recurring_delivery.blank? %>
                                  <% if @current_customer.hub.scan(/delivery/i).length == 1 && @requested_hub_to_change_to.blank? %>
                                    <% if @current_customer.delivery_address.blank?  %>
                                      <section class="row m-t-md">
                                        <div class="col-sm-12">
                                          <div class="alert alert-warning" style="margin-bottom:0 !important; font-size: 18px;">
                                            <i class="fa fa-ban-circle"></i>Please<a href="#delivery" data-toggle="tab" class="url_seg"> enter your delivery address</a> in the delivery tab.
                                          </div>
                                        </div>
                                      </section>                                      
                                    <% else %>
                                      <section class="row m-t-md">
                                        <div class="col-sm-12">
                                          <div class="alert alert-warning" style="margin-bottom:0 !important; font-size: 18px;">
                                            <i class="fa fa-ban-circle"></i>Please choose a pick-up hub.
                                          </div>
                                        </div>
                                      </section> 
                                    <% end %>                                  
                                  <% end %>
                                <% end %>
                                <% unless @sub_status.blank? %>
                                  <section class="row m-t-md">
                                    <div class="col-sm-12">
                                      <div class="alert alert-<%= @sub_status_color.blank? ? 'success' : @sub_status_color %>" style="margin-bottom:0 !important; font-size: 18px;">
                                        <button type="button" class="close" data-dismiss="alert">×</button>
                                        <%= raw @sub_status %>
                                      </div>
                                    </div>
                                  </section>
                                <% end %>
                                <section class="row m-b-md">
                                    <div class="col-sm-12">
                                        <h3 class="m-b-xs text-muted text-center">
                                    Welcome <%= @current_customer.name.split(/\s/)[0].capitalize %>! Your account is <span class="<%= @current_status_color %>"><%= raw @current_status %></span>
                                        </h3>
                                    </div>
                                </section>
                                <section class="row">
                                    <div class="col-sm-12">
                                        <div class="panel b-a">
                                            <div class="row m-n text-center">
                                                <div class="col-md-4">
                                                    <section class="row m-t-md m-b-md">
                                                      <div class="block padder-v hover">
                                                        <div class="col-md-4 col-md-offset-1 text-success-lt text-right">
                                                          <span class="i-s i-s-2x pull-left m-r-sm" >
                                                              <i class="i i-hexagon2 i-s-base text-changer hover-rotate"></i>
                                                              <i class="i i-plus2 i-1x text-white"></i>
                                                          </span>
                                                        </div>
                                                        <div class="col-md-7 text-left text-success-lt" style="margin-top: -25px; margin-left: -10px; padding-left: 0px;">
                                                              <span class="h2 block" style="height: 33px; margin-top: 20px; margin-bottom: 10px;"><%= @current_customer.total_meals_per_week %></span>
                                                              <small class="text-muted text-u-c">Weekly meals</small>
                                                        </div>  
                                                      </div>
                                                    </section>
                                                </div>
                                                <div class="col-md-4">
                                                    <section class="row m-t-md m-b-md">
                                                      <div class="block padder-v hover">
                                                        <div class="col-md-4 col-md-offset-1 text-primary-lt text-right">
                                                          <span class="i-s i-s-2x pull-left m-r-sm" >
                                                              <i class="i i-hexagon2 i-s-base text-changer hover-rotate"></i>
                                                              <i class="i i-alarm i-1x text-white"></i>
                                                          </span>
                                                        </div>
                                                        <div class="col-md-7 text-left text-primary-lt" style="margin-top: -25px; margin-left: -10px; padding-left: 0px;">
                                                              <span class="h4 block" style="height: 33px; margin-top: 30px; margin-bottom: 0px;"><%= @current_customer.next_pick_up_date.blank? ? "-" : @current_customer.next_pick_up_date.strftime("%b #{@current_customer.next_pick_up_date.day.ordinalize}") + " - " + (@current_customer.next_pick_up_date + 5.days).strftime("%b #{(@current_customer.next_pick_up_date + 5.days).day.ordinalize}") %></span>
                                                              <small class="text-muted text-u-c"><%= @current_pick_up_window_caption %></small>
                                                        </div>  
                                                      </div>
                                                    </section>
                                                </div>
                                                <div class="col-md-4">
                                                    <section class="row m-t-md m-b-md">
                                                      <div class="block padder-v hover">
                                                        <div class="col-md-4 col-md-offset-1 text-info-lt text-right">
                                                          <span class="i-s i-s-2x pull-left m-r-sm" >
                                                              <i class="i i-hexagon2 i-s-base text-changer hover-rotate"></i>
                                                              <i class="i i-alarm i-1x text-white"></i>
                                                          </span>
                                                        </div>
                                                        <div class="col-md-7 text-left text-info-lt" style="margin-top: -25px; margin-left: -10px; padding-left: 0px;">
                                                              <span class="h2 block" style="height: 33px; margin-top: 20px; margin-bottom: 10px;"><%= @next_billing_date.blank? ? "-" : @next_billing_date.strftime("%b #{@next_billing_date.day.ordinalize}") %></span>
                                                              <small class="text-muted text-u-c">Next billing</small>
                                                        </div>  
                                                      </div>
                                                    </section>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>
                                <section class="row m-b-md">
                                    <div class="col-sm-12">
                                        <h3 class="m-b-xs text-muted text-center">
                                          <% if @current_customer.recurring_delivery.blank? %>
                                            <% if @current_customer.monday_pickup_hub.blank? && @current_customer.stop_queues.where(stop_type: "change_hub").length == 0 %>
                                              <% if @current_customer.delivery_address.blank? %>
                                                Delivery requested
                                              <% else %>
                                                No pick-up hub selected
                                              <% end %>
                                            <% else %>
                                              Pick up at <%= @pick_up_text %>
                                            <% end %>
                                          <% else %>
                                            Delivery to <%= @current_customer.delivery_address %>
                                          <% end %>
                                        </h3>
                                        <% if @display_meal_selection %>
                                          <div class="row">
                                            <div class="col-md-12 text-center" style="padding: 0 10% 0 10%;">
                                              <p class="m-b-xs text-muted"><a href="#meal_selection" data-toggle="tab" class="url_seg" >Click here</a> to select your meals for <b><%= (@display_production_day_1 + 1.day).strftime("%A %b %e") %></b> and <b><%= (@display_production_day_2 + 1.day).strftime("%A %b %e") %></b>. Cut off for choosing your meals is <%= @cut_off_date.strftime("%A %b %e") %> at <%= @cut_off_date.wday == 0 ? '2pm' : 'midnight' %><% if @selection_timing_exception_for_new_customers %> (normally it's every Thursday at midnight, but we've extended it for you this week!)<% end %>. If no selection is made before the cut off then default selection will be sent.</p>
                                            </div>
                                          </div>
                                        <% end %>
                                    </div>
                                </section>
                                <section class="row">
                                  <section id="hub_map" class="wrapper"style="min-height: 350px; position: relative; overflow: hidden; transform: translateZ(0px); background-color: rgb(229, 227, 223);"></section>
                                </section>
                            </section>
                        </section>
                    </section>
                    
                    <section class="tab-pane" id="changePlan" role="tabpanel">
                        <section class="vbox">
                            <section class="scrollable padder">
                              <% if @number_of_failed_invoices > 0 %>
                                <section class="row m-t-xs">
                                  <div class="col-sm-12">
                                    <div class="alert alert-danger" style="margin-bottom:0 !important; font-size: 18px;">
                                      <i class="fa fa-ban-circle"></i>You have <strong><%= @number_of_failed_invoices %> overdue invoice </strong><%= "s" if @number_of_failed_invoices > 1 %> for the week<%= "s" if @number_of_failed_invoices > 1 %> of <%= @failed_weeks.to_sentence %> due to declined credit card. We will re-attempt in a few days. You can also<a href="#settings" data-toggle="tab" class="url_seg"> update your card</a> on your profile.
                                    </div>
                                  </div>
                                </section>
                              <% end %>
                              <% unless @sub_status.blank? %>
                                <section class="row m-t-md">
                                  <div class="col-sm-12">
                                    <div class="alert alert-<%= @sub_status_color.blank? ? 'success' : @sub_status_color %>" style="margin-bottom:0 !important; font-size: 18px;">
                                      <button type="button" class="close" data-dismiss="alert">×</button>
                                      <%= raw @sub_status %>
                                    </div>
                                  </div>
                                </section>
                              <% end %>
                                <section class="row m-b-xs m-t-md">
                                    <div class="col-sm-12">
                                        <h5 class="m-b-xs text-muted text-left">
                                            Subscription Details (you can increase it to up to 34 meals yourself. Please email us if you'd like more)
                                        </h5>
                                    </div>
                                </section>
                                <section class="row">
                                    <div class="col-sm-12">
                                        <div class="panel b-a">
                                            <div class="row m-n text-center">
                                                <div class="col-md-6 b-b">
                                                    <section class="row m-t-md m-b-md">
                                                      
                                                        <div class="col-md-12 text-center text-muted m-t-n-md container">
                                                          <div class="row">
                                                              <span class="h2 block" id="disp_reg" ><%= @total_meals %></span>
                                                              <small class="text-muted text-u-c">Total meals</small>
                                                          </div>
                                                          <div class="row row-centered">
                                                            <div class="col-md-6 col-centered" style="float:none; margin-top: -50px;">
                                                              <input type="text" id="total_meals_spinner" value="<%= @total_meals %>" style="opacity: 0;">
                                                            </div>
                                                          </div>
                                                        </div>  
                                                      
                                                    </section>
                                                </div>
                                                <div class="col-md-6 b-b">
                                                    <section class="row m-t-md m-b-md">
                                                      
                                                        <div class="col-md-12 text-center text-success-lt m-t-n-md container">
                                                          <div class="row">
                                                              <span class="h2 block" id="disp_grn"><%= @total_green %></span>
                                                              <small class="text-muted text-u-c">Green meals</small>
                                                          </div>
                                                          <div class="row row-centered">
                                                            <div class="col-md-6 6 col-centered" style="float:none; margin-top: -50px;">
                                                              <input type="text" id="green_meals_spinner" value="<%= @total_green %>" style="opacity: 0" >
                                                            </div>
                                                          </div>
                                                        </div>  
                                                      
                                                    </section>
                                                </div>
                                            </div>
                                            
                                              <%= form_tag update_customer_path("change_subscription"), method: 'POST', id:"change_meal_count" do %>
                                                <div class="row padder m-t-sm">
                                                  <div class="col-sm-8">
                                                    <div class="row">
                                                      <div class="col-sm-4">
                                                        <div class="checkbox i-checks">
                                                          <%= label_tag :no_pork do %>
                                                            <%= check_box_tag :no_pork,nil,@current_customer.no_pork %>
                                                            <i></i>
                                                            No Pork
                                                          <% end %>
                                                        </div>
                                                      </div>  
                                                      <div class="col-sm-4">
                                                        <div class="checkbox i-checks">
                                                          <%= label_tag :no_beef do %>
                                                            <%= check_box_tag :no_beef,nil,@current_customer.no_beef %>
                                                            <i></i>
                                                            No Beef
                                                          <% end %>
                                                        </div>
                                                      </div>  
                                                      <div class="col-sm-4">
                                                        <div class="checkbox i-checks">
                                                          <%= label_tag :no_poultry do %>
                                                            <%= check_box_tag :no_poultry,nil,@current_customer.no_poultry %>
                                                            <i></i>
                                                            No Poultry
                                                          <% end %>
                                                        </div>
                                                      </div>  
                                                    </div>
                                                  </div>
                                                </div>
                                                <div class="row">
                                                  <div class="col-sm-12">
                                                    <div class="alert" style="margin-bottom:0 !important;">
                                                      For non-delivery customers, please double check your meals at the hub to ensure that you received the correct meals. If not, simply ask the staff to change the meals for you.
                                                    </div>
                                                  </div>                                                  
                                                </div>

                                                <div class="row padder">
                                                  <div class="col-sm-2 padder-v">
                                                  
                                                    <%= hidden_field_tag :monday_reg_hidden, @monday_regular %>
                                                    <%= hidden_field_tag :monday_grn_hidden, @monday_green %>
                                                    <%= hidden_field_tag :thursday_reg_hidden, @thursday_regular %>
                                                    <%= hidden_field_tag :thursday_grn_hidden, @thursday_green  %>
                                                    <%= submit_tag 'Update Subscription', class:"btn btn-s-md btn-success disabled" %>          
                                                  </div>
                                                  <div class="col-sm-3 padder-v hidden" id="subscription_change_warning">
                                                    <div class="alert alert-warning alert-block text-center" style="height:34px; padding-top:8px;">
                                                      
                                                      You have unsaved changes
                                                    </div>
                                                  </div>
                                                </div>  
                                              <% end %>
                
                                             
                                        </div>
                                    </div>
                                </section>                           
                                <section class="row m-b-xs">
                                    <div class="col-sm-12">
                                        <h5 class="m-b-xs text-muted text-left">
                                            Change Pick-up Hub
                                        </h5>
                                    </div>
                                </section>
                                <section class="row">
                                    <div class="col-sm-12">
                                        <div class="panel b-a padder text-left padder-v">
                                            <%= form_tag update_customer_path("hub"), method: 'POST', class:"m-b-none", id:"hub_change_form" do %>
                                              <div class="form-group">
                                                <%= select_tag "hub", options_for_select(@hubs), id:"chosen-select-hub",include_blank: true,data: {placeholder: @requested_hub_to_change_to ? @requested_hub_to_change_to.cancel_reason : @current_customer.hub} %>
                                                <script>
                                                  $("#chosen-select-hub").chosen({
                                                    width: "330px",
                                                    disable_search: true
                                                  }).off("change").on("change",function(){
                                                    $("#hub_change_form input[type=submit]").removeClass("disabled");
                                                    $("#hub_change_warning div").removeClass("hidden");
                                                  })
                                                </script>
                                              </div>
                                              <div class="row m-b-n-md">
                                                <div class="col-sm-2 padder-v">
                                                  <%= submit_tag 'Update Hub', class:"btn btn-s-md btn-success disabled" %>
                                                </div>
                                                <div class="col-sm-3 padder-v " id="hub_change_warning">
                                                  <div class="alert alert-warning alert-block text-center hidden" style="height:34px; padding-top:8px;"> 
                                                    You have unsaved changes
                                                  </div>
                                                </div>
                                              </div>
                                            <% end %>
                                        </div>
                                    </div>
                                </section>                           
                                <section class="row m-b-xs">
                                    <div class="col-sm-12">
                                        <h5 class="m-b-xs text-muted text-left">
                                            Put Subscription on Hold (deadline to cancel or pause is the Thursday of every week)
                                        </h5>
                                    </div>
                                </section>
                                <section class="row">
                                    <div class="col-sm-12">
                                        <div class="panel b-a padder text-left">
                                            <div class="row">
                                              <% if @display_restart %>
                                                <div class="col-sm-2 m-b-md m-t-md">
                                                  <%= form_tag update_customer_path("restart"), method: 'POST' do %>
                                                      <%= submit_tag 'Resume Subscription', class:"btn btn-s-md btn-success", id: "resume_subscription_button" %>
                                                  <% end %>
                                                </div>
                                                <div class="col-sm-6 m-b-md m-t-md hidden" id="subscription_change_alert" style="margin-bottom:0 !important; font-size: 18px;">
                                                  <div class="alert alert-warning text-center" style="padding-top:8px; padding-bottom:8px; font-size: 18px;">
                                                    
                                                    You have unpaid invoices. Please <a href="#settings" data-toggle="tab" class="url_seg"> update your credit card</a> before resuming.
                                                  </div>
                                                </div>
                                              <% end %>
                                              <% if @display_pause %>
                                                <div class="col-sm-2 m-b-md m-t-md">
                                                  <div class="btn btn-s-md btn-default" data-toggle="modal" data-target="#pauseModal">Pause Subscription</div>
                                                </div>
                                              <% end %>
                                              <% if @display_cancel %>
                                                <div class="col-sm-2 m-b-md m-t-md">
                                                  <div class="btn btn-s-md btn-default" data-toggle="modal" data-target="#cancelModal">Cancel Subscription</div>
                                                </div>
                                              <% end %>
                                            </div>  
                                        </div>
                                    </div>
                                </section>                           
                            </section>
                        </section>
                    </section> 

                    <section class="tab-pane" id="referral" role="tabpanel">
                        <section class="vbox">
                            <section class="scrollable padder">
                              <% if flash[:notice_referral] %>
                                <div class="row m-t-sm">
                                  <div class="col-sm-12">
                                    <div class="alert alert-<%= flash[:status] == "success" ? "success" : "danger" %>" style="margin-bottom:0 !important; font-size: 18px;">
                                      <%= flash[:notice_referral] %>
                                    </div>
                                  </div>
                                </div>
                              <% end %>
                                <section class="row m-b-xs m-t-md">
                                    <div class="col-sm-12">
                                        <h5 class="m-b-xs text-muted text-left">
                                            Your referrals
                                        </h5>
                                    </div>
                                </section>
                                <section class="row">
                                    <div class="col-sm-12">
                                        <div class="panel b-a">
                                          <div class="panel-heading no-border bg-light lt text-center"><h4>Your referral code is: <span class="text-primary-lt"><%= @current_customer.referral_code %></span></h4>
                                            <div class="row m-l-md m-r-md padder">
                                              <p>For every friend who signs up with this code, both you and your friend get $10 in meal credits</p>
                                            </div>                                            
                                            <div class="row">
                                              <a rel="me" href="https://twitter.com/intent/tweet?text=Try%20Chowdy%20$7.99%20meal%20subscription%20with%20referral%20code%20<%= @current_customer.referral_code %>,%20get%20$10%20off&url=http://chowdy.ca" class="btn btn-rounded btn-lg text-info-lt" style="font-size: 25px" target="_blank"><i class="fa fa-twitter"></i></a>
                                              <a href="https://www.facebook.com/dialog/feed?app_id=<%= ENV["FACEBOOK_APP_ID"] %>&redirect_uri=http://chowdy.ca&link=http://chowdy.ca&caption=$7.99%20meal%20subscription%20for%20Toronto%20professionals&description=Sign%20up%20with%20referral%20code%20<%= @current_customer.referral_code %>,%20get%20$10%20off" class="btn btn-rounded btn-lg text-primary" style="font-size: 25px" target="_blank"><i class="fa fa-facebook"></i></a>
                                              <a href="mailto:?subject=Try%20Chowdy&body=Sign%20up%20to%20Chowdy%20$7.99%20meal%20subscription%20with%20referral%20code%20<%= @current_customer.referral_code %>,%20get%20$10%20off%20%20http://chowdy.ca%0A%0A<%= @current_customer.name.split(/\s/)[0].capitalize %>" class="btn btn-rounded btn-lg text-muted" style="font-size: 25px" ><i class="i i-mail"></i></a>
                                            </div>
                                          </div>
                                            <div class="row m-n text-center">
                                                <div class="col-md-6">
                                                    <section class="row m-t-md m-b-md">
                                                      <div class="block padder-v hover">
                                                        <div class="col-md-4 col-md-offset-1 text-success-lt text-right">
                                                          <span class="i-s i-s-2x pull-left m-r-sm" >
                                                              <i class="i i-hexagon2 i-s-base text-changer hover-rotate"></i>
                                                              <i class="fa fa-user text-white"></i>
                                                          </span>
                                                        </div>
                                                        <div class="col-md-7 text-left text-success-lt" style="margin-top: -25px; margin-left: -10px; padding-left: 0px;">
                                                              <span class="h2 block"><%= @number_of_referrals %></span>
                                                              <small class="text-muted text-u-c">People referred</small>
                                                        </div>  
                                                      </div>
                                                    </section>
                                                </div>
                                                <div class="col-md-6">
                                                    <section class="row m-t-md m-b-md">
                                                      <div class="block padder-v hover">
                                                        <div class="col-md-4 col-md-offset-1 text-primary-lt text-right">
                                                          <span class="i-s i-s-2x pull-left m-r-sm" >
                                                              <i class="i i-hexagon2 i-s-base text-changer hover-rotate"></i>
                                                              <i class="i i-star2 i-1x text-white"></i>
                                                          </span>
                                                        </div>
                                                        <div class="col-md-7 text-left text-primary-lt" style="margin-top: -25px; margin-left: -10px; padding-left: 0px;">
                                                              <span class="h2 block">$<%= @referral_dollars_earned %></span>
                                                              <small class="text-muted text-u-c">Credits earned</small>
                                                        </div>  
                                                      </div>
                                                    </section>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </section>

                                <section class="row m-b-xs">
                                    <div class="col-sm-12">
                                        <h5 class="m-b-xs text-muted text-left">
                                            Apply promo code
                                        </h5>
                                    </div>
                                </section>
                                <section class="row">
                                    <div class="col-sm-12">
                                        <div class="panel b-a padder text-left padder-v">
                                            <%= form_tag redeem_promo_path, method: 'POST', class:"m-b-none" do %>
                                              <div class="row">
                                                <div class="col-sm-4">
                                                  <div class="form-group">
                                                    <%= text_field_tag 'promo_code', nil, class:"form-control" %>
                                                  </div>
                                                </div>
                                                <div class="col-sm-3">
                                                  <%= submit_tag 'Apply code', class:"btn btn-s-md btn-success" %>
                                                </div>
                                                </div>
                                              </div>
                                            <% end %>
                                        </div>
                                    </div>
                                </section>                           


                            </section>
                        </section>
                    </section>


                    <section class="tab-pane" id="delivery" role="tabpanel">
                      <section class="vbox">
                        <section class="scrollable padder">   
                          <% if flash[:notice_delivery] %>
                            <div class="row m-t-sm">
                              <div class="col-sm-12">
                                <div class="alert alert-<%= flash[:status] %>" style="margin-bottom:0 !important; font-size: 18px;">
                                  <%= raw flash[:notice_delivery] %>
                                </div>
                              </div>
                            </div>
                          <% end %>                   
                          <div class="row">
                            <div class="col-sm-6">
                              <div class="alert alert-<%= @delivery_color_class %> m-t-md padder-v">
                                  <h5><%= @delivery_note %></h5>
                                  <% unless @current_customer.recurring_delivery.blank? %>
                                    <%= form_tag update_customer_path("stop_delivery"), method: 'POST', class: "m-b-none m-t-xs" do %>
                                        <%= submit_tag "Switch to pick-up (stop delivery)", class:"btn btn-sm btn-danger"  %>
                                        <div class="alert alert-warning m-t-md m-b-xs">
                                        Note that stopping delivery here will be effective immediately for your next batch (<b><%= Date.today < @current_customer.first_pick_up_date ? @current_customer.first_pick_up_date.strftime("%B %d") : ([1,2,3].include?(Date.today.wday) ? Chowdy::Application.closest_date(1,4).strftime("%B %d") : Chowdy::Application.closest_date(1,1).strftime("%B %d")) %></b>). If you have already requested pause/cancel for your subscription, you do <b>not</b> need to separately request stop delivery here</div>
                                    <% end %>
                                  <% end %>
                              </div>
                            </div>
                          </div>
                          <div class="row">
                            <div class="col-sm-6">
                              <section class="panel panel-default">
                                <header class="panel-heading font-bold">Delivery request form ($8 per drop)<span id="delivery_time_notice"><% if @delivery_boundary == "downtown" %> - note that <span class="text-danger-lt">default delivery time is every Monday and Thursday between 11am and 1pm</span> unless otherwise requested below. <br><br>If you live in a residence with a front desk, please make sure that your concierge can accept the delivery on your behalf, or will let our courier leave the food by your door (note that since you are in our downtown delivery zone, your meals will come in regular bags, not thermal-insulated bags. So if you cannot receive your meals during our default delivery time, please indicate below a better time for delivery)<br><br>If our courier cannot drop off the meals, they will return them to the hub, where you're welcome to pick up the meals yourself.<% elsif @delivery_boundary == "GTA" %> - your meals will be delivered between 10am and 3pm every Monday and Thursday in a thermal insulated bag. Our couriers will call you when they arrive. <br><br>If you live in a residence with a front desk, please make sure that your concierge can accept the delivery on your behalf, or will let our courier leave the food by your door (in case you are not home)<br><br>If you can, please return the insulated thermal bags and ice packs to our courier so we can reuse them and minimize waste<% end %></span></header>
                                <div class="panel-body">
                                  <%= form_tag update_customer_path("delivery"), method: 'POST', role: 'form', id:"delivery_request_form" do %>
                                    <div class="form-group">
                                      <%= label_tag 'phone_number', "Phone number" %>
                                      <%= telephone_field_tag 'phone_number', @phone_number, class:"form-control" %>
                                    </div>
                                    <div class="form-group">
                                      <%= label_tag 'delivery_address', "Delivery address" %>
                                      <%= text_field_tag 'delivery_address', @delivery_address, class: "form-control" %>
                                      <div class="alert alert-warning m-t-xs hidden" id="address_match_warning">
                                          <strong></strong>
                                      </div>
                                    </div>
                                    <div class="form-group">
                                      <%= label_tag 'unit_number', "Unit number" %>
                                      <%= text_field_tag 'unit_number', @unit_number, class: "form-control" %>
                                    </div>
                                    <div class="form-group">
                                      <%= label_tag 'note', "Additional note #{"(we cannot deliver after 5pm)" if @delivery_boundary == "downtown"}" %>
                                      <%= text_area_tag 'note', @note, class: "form-control" %>
                                    </div>
                                    <%= hidden_field_tag 'boundary', @delivery_boundary %>
                                    <div class="row">
                                      <div class="col-sm-5 m-t-md">
                                        <%= submit_tag @delivery_button, class:"btn btn-md btn-default #{"disabled" unless @do_not_disable_delivery_button_initially}", id: "request_delivery_submit" %>
                                      </div>
                                      <div class="col-sm-7 m-t-md">
                                        <div class="alert alert-warning alert-block text-center hidden" id="delivery_change_warning" style="height:34px; padding-top:8px;">
                                          
                                          You have unsaved changes
                                        </div>
                                      </div>
                                    </div>
                                  <% end %>
                                </div>
                              </section>
                            </div>
                          </div>                      
                        </section>
                      </section>                      
                    </section>


                    <section class="tab-pane" id="settings" role="tabpanel">
                      <section class="vbox">
                        <section class="scrollable padder"> 
                          <% if flash[:notice_customer_setting] %>
                            <div class="row m-t-xs">
                              <div class="col-sm-12">
                                <div class="alert alert-<%= flash[:status] == "success" ? "success" : "danger" %>" style="margin-bottom:0 !important; font-size: 18px;">
                                  <%= flash[:notice_customer_setting] %>
                                </div>
                              </div>
                            </div>
                          <% end %>
                          <% if @number_of_failed_invoices > 0 %>
                            <section class="row m-t-xs">
                              <div class="col-sm-12">
                                <div class="alert alert-danger" style="margin-bottom:0 !important; font-size: 18px;">
                                  <i class="fa fa-ban-circle"></i>You have <strong><%= @number_of_failed_invoices %> overdue invoice </strong><%= "s" if @number_of_failed_invoices > 1 %> for the week<%= "s" if @number_of_failed_invoices > 1 %> of <%= @failed_weeks.to_sentence %> due to declined credit card. We will re-attempt in a few days. You can also<a href="#settings" data-toggle="tab" class="url_seg"> update your card</a> on your profile.
                                </div>
                              </div>
                            </section>
                          <% end %>

                          <div class="row m-t-md">
                            <div class="col-sm-6">
                              <section class="panel panel-default">
                                <header class="panel-heading font-bold">Update account information</header>
                                <div class="panel-body">
                                  <%= form_tag update_customer_path("email"), method: 'POST', role: "form" do %>
                                    <div class="form-group">
                                      <%= label_tag 'email', "Email" %>
                                      <%= text_field_tag 'email', @current_customer.email, class: "form-control" %>
                                      <%= submit_tag 'Update email', class:"btn btn-md btn-default m-t-sm" %>
                                    </div>
                                  <% end %>
                                  <div class="line line-dashed b-b line-lg pull-in"></div>
                                  <%= form_tag update_customer_path("name"), method: 'POST' do %>
                                    <div class="form-group">
                                      <%= label_tag 'name', "Name" %>
                                      <%= text_field_tag 'name', @current_customer.name, class: "form-control" %>
                                      <%= submit_tag 'Update name', class:"btn btn-md btn-default m-t-sm" %>
                                    </div>
                                  <% end %>
                                  <div class="line line-dashed b-b line-lg pull-in"></div>
                                  <%= form_tag update_customer_path("change_card"), id:"change_card_form" do %>
                                    <div class="form-group">
                                      <label>Credit Card</label>
                                      <p class="form-control-static"><%= @card_brand %> ending in <%= @card_last4 %></p>
                                        <script>
                                        $(function() {
                                            $('#change_card_form input[type=submit]').on('click', function(event) {
                                                event.preventDefault();

                                                var $button = $(this),
                                                    $form = $button.parents('form');

                                                var opts = $.extend({}, $button.data(), {
                                                    token: function(result) {
                                                        $form.append($('<input>').attr({ type: 'hidden', name: 'stripeToken', value: result.id })).submit();
                                                    }
                                                });

                                                StripeCheckout.open(opts);
                                            });
                                        });
                                        </script>
                                        <%= submit_tag 'Change Card', class:"btn btn-md btn-info m-t-sm", data: {key: Rails.configuration.stripe[:publishable_key], description: "Update your credit card info", amount:"0", label:"Change Card", panel_label: "Change Now"} %>
                                    </div>
                                  <% end %>
                                  <div class="line line-dashed b-b line-lg pull-in"></div>
                                  <div class="form-group">
                                    <label>Service feedback (<a href="#rate_menu" data-toggle="tab" class="url_seg">click here</a> to provide meal-specific feedback)</label>
                                    <p class="form-control-static">
                                      <div class="btn btn-md btn-success"  data-toggle="modal" data-target="#feedbackModal">Provide Feedback
                                      </div>
                                    </p>
                                  </div>
                                </div>
                              </section>
                            </div>
                          </div>
                        </section>
                      </section>                      
                    </section>  

                    <section class="tab-pane" id="help" role="tabpanel">
                      <section class="vbox">
                        <section class="scrollable padder"> 
                          <div class="row m-t-md">
                            <div class="col-sm-12">
                              If you do not see your answer here, feel free to email <a href="mailto:help@chowdy.ca">help@chowdy.ca</a>  
                            </div>
                            
                          </div>
                          <div class="row m-t-md">
                            <div class="col-sm-4">
                              <section class="panel default-panel">
                                <header class="panel-heading no-border bg-light lt text-center font-bold">
                                  Selecting and managing meals for pick up
                                </header>
                                <div class="panel-body">
                                  <ul style="list-style:none; padding-left:0;">
                                    <li>
                                      <section class="panel portlet-item" style="-webkit-box-shadow: none; box-shadow: none;">
                                        <header class="panel-heading" style="padding-left:0; padding-right:0;">
                                          <a href="#" class="panel-toggle text-muted">
                                            <span class="font-bold">How do I select my meals?</span>
                                            <i class="fa fa-caret-down text nav nav-pills pull-right" style="margin:3px 16px;"></i><i class="fa fa-caret-up text-active nav nav-pills pull-right" style="margin:3px 16px;"></i>
                                          </a>
                                        </header>
                                        <section class="panel-body collapse" style="padding-left:0; padding-right:0;">
                                          <span>You can log into your Chowdy account and set your meal preferences under <a href="#changePlan" data-toggle="tab" class="url_seg">Manage Subscription</a>.<br><br>
                                          When you go to the hub to pick up, you are free to choose your own meals, but please make sure you’ve selected any meal preferences to keep things balanced for other subscribers who pick up.</span>                                          
                                        </section>
                                      </section>
                                    </li>
                                    <div class="line line-dashed b-b line-lg"></div>
                                    <li>
                                      <section class="panel portlet-item" style="-webkit-box-shadow: none; box-shadow: none;">
                                        <header class="panel-heading" style="padding-left:0; padding-right:0;">
                                          <a href="#" class="panel-toggle text-muted">
                                            <span class="font-bold">When do I start my meal plan?</span>
                                            <i class="fa fa-caret-down text nav nav-pills pull-right" style="margin:3px 16px;"></i><i class="fa fa-caret-up text-active nav nav-pills pull-right" style="margin:3px 16px;"></i>
                                          </a>
                                        </header>
                                        <section class="panel-body collapse" style="padding-left:0; padding-right:0;">
                                          <span>Your meal plan officially begins on the date indicated in your confirmation email and on the signup page.<br><br>
                                        You can pick up or get your meals delivered twice a week. Fresh batches are available Monday and Thursday. You have a 3 day window to pick up every batch for food safety reasons.</span>                                          
                                        </section>
                                      </section>
                                    </li>
                                    <div class="line line-dashed b-b line-lg"></div>
                                    <li>
                                      <section class="panel portlet-item" style="-webkit-box-shadow: none; box-shadow: none;">
                                        <header class="panel-heading" style="padding-left:0; padding-right:0;">
                                          <a href="#" class="panel-toggle text-muted">
                                            <span class="font-bold">Where and when do I pick up my meals?</span>
                                            <i class="fa fa-caret-down text nav nav-pills pull-right" style="margin:3px 16px;"></i><i class="fa fa-caret-up text-active nav nav-pills pull-right" style="margin:3px 16px;"></i>
                                          </a>
                                        </header>
                                        <section class="panel-body collapse" style="padding-left:0; padding-right:0;">
                                          <span>Your meals can be picked up from the hub you’ve selected, during regular store hours. You can see your current hub along with store hours on your <a href="#dashboard" data-toggle="tab" class="url_seg">Dashboard</a> when you log into your Chowdy account.</span>                                          
                                        </section>
                                      </section>
                                    </li>
                                  </ul>
                                </div>
                              </section>
                            </div>
                            <div class="col-sm-4">
                              <section class="panel default-panel">
                                <header class="panel-heading no-border bg-light lt text-center font-bold">
                                  Setting up optional delivery
                                </header>
                                <div class="panel-body">
                                  <ul style="list-style:none; padding-left:0;">
                                    <li>
                                      <section class="panel portlet-item" style="-webkit-box-shadow: none; box-shadow: none;">
                                        <header class="panel-heading" style="padding-left:0; padding-right:0;">
                                          <a href="#" class="panel-toggle text-muted">
                                            <span class="font-bold">How much is delivery?</span>
                                            <i class="fa fa-caret-down text nav nav-pills pull-right" style="margin:3px 16px;"></i><i class="fa fa-caret-up text-active nav nav-pills pull-right" style="margin:3px 16px;"></i>
                                          </a>
                                        </header>
                                        <section class="panel-body collapse" style="padding-left:0; padding-right:0;">
                                          <span>Delivery is $8 per drop off, $16 total for the week.</span>                                          
                                        </section>
                                      </section>
                                    </li>
                                    <div class="line line-dashed b-b line-lg"></div>
                                    <li>
                                      <section class="panel portlet-item" style="-webkit-box-shadow: none; box-shadow: none;">
                                        <header class="panel-heading" style="padding-left:0; padding-right:0;">
                                          <a href="#" class="panel-toggle text-muted">
                                            <span class="font-bold">How do I set up delivery?</span>
                                            <i class="fa fa-caret-down text nav nav-pills pull-right" style="margin:3px 16px;"></i><i class="fa fa-caret-up text-active nav nav-pills pull-right" style="margin:3px 16px;"></i>
                                          </a>
                                        </header>
                                        <section class="panel-body collapse" style="padding-left:0; padding-right:0;">
                                          <span>You can set up delivery under the <a href="#delivery" data-toggle="tab" class="url_seg">Delivery</a> option in your Chowdy account.</span>                                          
                                        </section>
                                      </section>
                                    </li>
                                    <div class="line line-dashed b-b line-lg"></div>
                                    <li>
                                      <section class="panel portlet-item" style="-webkit-box-shadow: none; box-shadow: none;">
                                        <header class="panel-heading" style="padding-left:0; padding-right:0;">
                                          <a href="#" class="panel-toggle text-muted">
                                            <span class="font-bold">When does delivery happen?</span>
                                            <i class="fa fa-caret-down text nav nav-pills pull-right" style="margin:3px 16px;"></i><i class="fa fa-caret-up text-active nav nav-pills pull-right" style="margin:3px 16px;"></i>
                                          </a>
                                        </header>
                                        <section class="panel-body collapse" style="padding-left:0; padding-right:0;">
                                          <span>Deliveries are made every Monday and Thursday.<br><br>For our downtown delivery, you can expect the meals to arrive around lunch time (11am to 1pm) unless otherwise requested.
                                          <br>
                                          <br>
                                          For GTA deliveries, the meals will arrive between 10am-3pm.</span>                                    
                                        </section>
                                      </section>
                                    </li>
                                  </ul>
                                </div>
                              </section>
                            </div>
                            <div class="col-sm-4">
                              <section class="panel default-panel">
                                <header class="panel-heading no-border bg-light lt text-center font-bold">
                                  Managing my account
                                </header>
                                <div class="panel-body">
                                  <ul style="list-style:none; padding-left:0;">
                                    <li>
                                      <section class="panel portlet-item" style="-webkit-box-shadow: none; box-shadow: none;">
                                        <header class="panel-heading" style="padding-left:0; padding-right:0;">
                                          <a href="#" class="panel-toggle text-muted">
                                            <span class="font-bold">How do I pause/change my subscription?</span>
                                            <i class="fa fa-caret-down text nav nav-pills pull-right" style="margin:3px 16px;"></i><i class="fa fa-caret-up text-active nav nav-pills pull-right" style="margin:3px 16px;"></i>
                                          </a>
                                        </header>
                                        <section class="panel-body collapse" style="padding-left:0; padding-right:0;">
                                          <span>You can pause or cancel your meal subscription (along with other changes) under <a href="#changePlan" data-toggle="tab" class="url_seg">Manage Subscription</a> on your Chowdy account.</a><br><br>

                                            Please remember to make any account changes by the Thursday of every week as that is the cut off date. (We order your fresh ingredients ahead of time to keep the meal plan affordable).</span>                                    
                                        </section>
                                      </section>
                                    </li>
                                    <div class="line line-dashed b-b line-lg"></div>
                                    <li>
                                      <section class="panel portlet-item" style="-webkit-box-shadow: none; box-shadow: none;">
                                        <header class="panel-heading" style="padding-left:0; padding-right:0;">
                                          <a href="#" class="panel-toggle text-muted">
                                            <span class="font-bold">Do you provide calories and other nutritional info for every meal?</span>
                                            <i class="fa fa-caret-down text nav nav-pills pull-right" style="margin:3px 16px;"></i><i class="fa fa-caret-up text-active nav nav-pills pull-right" style="margin:3px 16px;"></i>
                                          </a>
                                        </header>
                                        <section class="panel-body collapse" style="padding-left:0; padding-right:0;">
                                          <span>It’s still a work in progress!<br><br>
                                            Our menu is always changing based on what the chefs can source locally so we do not have standardized meals every week. We are currently working on creating accurate nutritional info for subscribers while developing more healthy and affordable meals.  
                                          </span>                                    
                                        </section>
                                      </section>
                                    </li>
                                  </ul>
                                </div>
                              </section>
                            </div>
                          </div>
                        </section>
                      </section>                      
                    </section>  


                    <section class="tab-pane" id="rate_menu" role="tabpanel">
                      <section class="vbox">
                        <section class="scrollable padder"> 
                          <div class="row">
                            <div class="col-sm-6 b-r b-3x">
                              <div class="row m-t-md padder">
                                <div class="col-sm-12 b-b b-3x"><b>Meals for Monday - Wednesday (<%= (@menu_date_sunday+1.day).strftime("%b %d") %> - <%= (@menu_date_sunday+3.day).strftime("%b %d") %>)</b></div>
                              </div>  
                              <div class="row m-t-md padder menu_card animated fade_left" data-menu-id="<%= @beef_monday_id ||= 0 %>">
                                <div class="col-sm-12">
                                  <section class="panel b-a animated fadeInUp" style="border: none;" id="rating_monday_beef">
                                    <div class="panel-heading no-border bg-dark">
                                      <span class="font-bold" style="color: #FFFFFF "><%= raw @beef_monday %></span>
                                    </div>
                                    <div class="panel-body no-border">
                                      Feedback for this item
                                      <section class="scrollable bg-light lter">
                                        <textarea rows="3" class="form-control scrollable"></textarea>
                                        <%= hidden_field_tag 'menu_id', @beef_monday_id ||= 0 %>
                                      </section>
                                    </div>
                                    <div class="clearfix panel-footer no-border">
                                      <div class="star_rating pull-left"></div>
                                      <div class="submit_meal_rating pull-right btn btn-default disabled" id="submit_rating_monday_beef">Submit rating</div>
                                    </div>
                                  </section>
                                </div>
                              </div>
                              <div class="row m-t-md padder menu_card animated fade_left" data-menu-id="<%= @pork_monday_id ||= 0 %>">
                                <div class="col-sm-12">
                                  <section class="panel b-a animated fadeInUp" style="border: none;" id="rating_monday_pork">
                                    <div class="panel-heading no-border bg-black lter">
                                      <span class="font-bold" style="color: #FFFFFF"><%= raw @pork_monday %></span>
                                    </div>
                                    <div class="panel-body no-border">
                                      Feedback for this item
                                      <section class="scrollable bg-light lter">
                                        <textarea rows="3" class="form-control scrollable"></textarea>
                                        <%= hidden_field_tag 'menu_id', @pork_monday_id ||= 0 %>
                                      </section>
                                    </div>
                                    <div class="clearfix panel-footer no-border">
                                      <div class="star_rating pull-left"></div>
                                      <div class="submit_meal_rating pull-right btn btn-default disabled" id="submit_rating_monday_pork">Submit rating</div>
                                    </div>
                                  </section>
                                </div>                              
                              </div>
                              <div class="row m-t-md padder menu_card animated fade_left" data-menu-id="<%= @poultry_monday_id ||= 0 %>">
                                <div class="col-sm-12">
                                  <section class="panel b-a animated fadeInUp" style="border: none;" id="rating_monday_poultry">
                                    <div class="panel-heading no-border bg-black lter">
                                      <span class="font-bold" style="color: #FFFFFF "><%= raw @poultry_monday %></span>
                                    </div>
                                    <div class="panel-body no-border">
                                      Feedback for this item
                                      <section class="scrollable bg-light lter">
                                        <textarea rows="3" class="form-control scrollable"></textarea>
                                        <%= hidden_field_tag 'menu_id', @poultry_monday_id ||= 0 %>
                                      </section>
                                    </div>
                                    <div class="clearfix panel-footer no-border">
                                      <div class="star_rating pull-left"></div>
                                      <div class="submit_meal_rating pull-right btn btn-default disabled" id="submit_rating_monday_poultry">Submit rating</div>
                                    </div>
                                  </section>
                                </div>                              
                              </div>
                              <div class="row m-t-md padder menu_card animated fade_left" data-menu-id="<%= @green_1_monday_id ||= 0 %>">
                                <div class="col-sm-12">
                                  <section class="panel b-a animated fadeInUp" style="border: none;" id="rating_monday_green_1">
                                    <div class="panel-heading no-border bg-success lter">
                                      <span class="font-bold" style="color: #FFFFFF "><%= raw @green_1_monday %></span>
                                    </div>
                                    <div class="panel-body no-border">
                                      Feedback for this item
                                      <section class="scrollable bg-light lter">
                                        <textarea rows="3" class="form-control scrollable"></textarea>
                                        <%= hidden_field_tag 'menu_id', @green_1_monday_id ||= 0 %>
                                      </section>
                                    </div>
                                    <div class="clearfix panel-footer no-border">
                                      <div class="star_rating pull-left"></div>
                                      <div class="submit_meal_rating pull-right btn btn-default disabled" id="submit_rating_monday_green_1">Submit rating</div>
                                    </div>
                                  </section>
                                </div>                              
                              </div>
                              <div class="row m-t-md padder menu_card animated fade_left" data-menu-id="<%= @green_2_monday_id ||= 0 %>">
                                <div class="col-sm-12">
                                  <section class="panel b-a animated fadeInUp" style="border: none;" id="rating_monday_green_2">
                                    <div class="panel-heading no-border bg-success lter">
                                      <span class="font-bold" style="color: #FFFFFF "><%= raw @green_2_monday %></span>
                                    </div>
                                    <div class="panel-body no-border">
                                      Feedback for this item
                                      <section class="scrollable bg-light lter">
                                        <textarea rows="3" class="form-control scrollable"></textarea>
                                        <%= hidden_field_tag 'menu_id', @green_2_monday_id ||= 0 %>

                                      </section>
                                    </div>
                                    <div class="clearfix panel-footer no-border">
                                      <div class="star_rating pull-left"></div>
                                      <div class="submit_meal_rating pull-right btn btn-default disabled" id="submit_rating_monday_green_2">Submit rating</div>
                                    </div>
                                  </section>
                                </div>                              
                              </div>
                            </div>
                            <div class="col-sm-6">
                              <div class="row m-t-md padder">
                                <div class="col-sm-12 b-b b-3x"><b>Meals for Thursday - Saturday (<%= (@menu_date_sunday+4.day).strftime("%b %d") %> - <%= (@menu_date_sunday+6.day).strftime("%b %d") %>)</b></div>
                              </div>  
                              <div class="row m-t-md padder menu_card animated fade_right" data-menu-id="<%= @beef_thursday_id ||= 0 %>">
                                <div class="col-sm-12">
                                  <section class="panel b-a animated fadeInUp" style="border: none;" id="rating_monday_beef">
                                    <div class="panel-heading no-border bg-dark">
                                      <span class="font-bold" style="color: #FFFFFF "><%= raw @beef_thursday %></span>
                                    </div>
                                    <div class="panel-body no-border">
                                      Feedback for this item
                                      <section class="scrollable bg-light lter">
                                        <textarea rows="3" class="form-control scrollable"></textarea>
                                        <%= hidden_field_tag 'menu_id', @beef_thursday_id ||= 0 %>
                                      </section>
                                    </div>
                                    <div class="clearfix panel-footer no-border">
                                      <div class="star_rating pull-left"></div>
                                      <div class="submit_meal_rating pull-right btn btn-default disabled" id="submit_rating_thursday_beef">Submit rating</div>
                                    </div>
                                  </section>
                                </div>
                              </div>
                              <div class="row m-t-md padder menu_card animated fade_right" data-menu-id="<%= @pork_thursday_id ||= 0 %>">
                                <div class="col-sm-12">
                                  <section class="panel b-a animated fadeInUp" style="border: none;" id="rating_thursday_pork">
                                    <div class="panel-heading no-border bg-black lter">
                                      <span class="font-bold" style="color: #FFFFFF"><%= raw @pork_thursday %></span>
                                    </div>
                                    <div class="panel-body no-border">
                                      Feedback for this item
                                      <section class="scrollable bg-light lter">
                                        <textarea rows="3" class="form-control scrollable"></textarea>
                                        <%= hidden_field_tag 'menu_id', @pork_thursday_id ||= 0 %>
                                      </section>
                                    </div>
                                    <div class="clearfix panel-footer no-border">
                                      <div class="star_rating pull-left"></div>
                                      <div class="submit_meal_rating pull-right btn btn-default disabled" id="submit_rating_thursday_pork">Submit rating</div>
                                    </div>
                                  </section>
                                </div>                              
                              </div>
                              <div class="row m-t-md padder menu_card animated fade_right" data-menu-id="<%= @poultry_thursday_id ||= 0 %>">
                                <div class="col-sm-12">
                                  <section class="panel b-a animated fadeInUp" style="border: none;" id="rating_thursday_poultry">
                                    <div class="panel-heading no-border bg-black lter">
                                      <span class="font-bold" style="color: #FFFFFF "><%= raw @poultry_thursday %></span>
                                    </div>
                                    <div class="panel-body no-border">
                                      Feedback for this item
                                      <section class="scrollable bg-light lter">
                                        <textarea rows="3" class="form-control scrollable"></textarea>
                                        <%= hidden_field_tag 'menu_id', @poultry_thursday_id ||= 0 %>
                                      </section>
                                    </div>
                                    <div class="clearfix panel-footer no-border">
                                      <div class="star_rating pull-left"></div>
                                      <div class="submit_meal_rating pull-right btn btn-default disabled" id="submit_rating_thursday_poultry">Submit rating</div>
                                    </div>
                                  </section>
                                </div>                              
                              </div>
                              <div class="row m-t-md padder menu_card animated fade_right" data-menu-id="<%= @green_1_thursday_id ||= 0 %>">
                                <div class="col-sm-12">
                                  <section class="panel b-a animated fadeInUp" style="border: none;" id="rating_thursday_green_1">
                                    <div class="panel-heading no-border bg-success lter">
                                      <span class="font-bold" style="color: #FFFFFF "><%= raw @green_1_thursday %></span>
                                    </div>
                                    <div class="panel-body no-border">
                                      Feedback for this item
                                      <section class="scrollable bg-light lter">
                                        <textarea rows="3" class="form-control scrollable"></textarea>
                                        <%= hidden_field_tag 'menu_id', @green_1_thursday_id ||= 0 %>
                                      </section>
                                    </div>
                                    <div class="clearfix panel-footer no-border">
                                      <div class="star_rating pull-left"></div>
                                      <div class="submit_meal_rating pull-right btn btn-default disabled" id="submit_rating_thursday_green_1">Submit rating</div>
                                    </div>
                                  </section>
                                </div>                              
                              </div>
                              <div class="row m-t-md padder menu_card animated fade_right" data-menu-id="<%= @green_2_thursday_id ||= 0 %>">
                                <div class="col-sm-12">
                                  <section class="panel b-a animated fadeInUp" style="border: none;" id="rating_thursday_green_2">
                                    <div class="panel-heading no-border bg-success lter">
                                      <span class="font-bold" style="color: #FFFFFF "><%= raw @green_2_thursday %></span>
                                    </div>
                                    <div class="panel-body no-border">
                                      Feedback for this item
                                      <section class="scrollable bg-light lter">
                                        <textarea rows="3" class="form-control scrollable"></textarea>
                                        <%= hidden_field_tag 'menu_id', @green_2_thursday_id ||= 0 %>

                                      </section>
                                    </div>
                                    <div class="clearfix panel-footer no-border">
                                      <div class="star_rating pull-left"></div>
                                      <div class="submit_meal_rating pull-right btn btn-default disabled" id="submit_rating_thursday_green_2">Submit rating</div>
                                    </div>
                                  </section>
                                </div>                              
                              </div>                              
                            </div>
                          </div>
                        </section>
                      </section>                      
                    </section>  
      
                    <% if @display_meal_selection %>
                      <section class="tab-pane" id="meal_selection" role="tabpanel">
                        <section class="vbox">
                          <section class="scrollable padder"> 
                            <div class="row m-t-lg">
                              <div class="col-lg-2 col-md-2 col-sm-4 col-xs-4">
                                <button class="btn btn-s-md btn-success disabled" id="submit_meal_selection">Submit Selection</button>                            
                              </div>
                              <div class="col-lg-5 col-md-5 col-sm-5 col-xs-8">
                                <div class="alert alert-warning alert-block text-center hidden" style="height:34px; padding-top:8px; margin: 0;" id="unsaved_warning_meal_selection">
                                  
                                  You have unsaved changes
                                </div>
                              </div>  
                            </div>
                            <div class="row">
                              <div class="col-lg-5"><a href="<%= view_meals_selection_path %>?week_date=<%= @view_meal_selection_date %>" class="pull_modal">View meals selected for week of <%= @view_meal_selection_date.strftime("%B %e") %></a></div>
                            </div>
                            <div class="row m-t-sm padder">
                              Meal selection for <b style="font-size:15px;"><%= (@display_production_day_1 + 1.day).strftime("%A %B %e") %></b> (Meals remaining: <span id="monday_selection_full">none. You have selected all your meals! You can add more meals in <a href="#changePlan" data-toggle="tab" class="url_seg">Manage Subscription</a> tab</span><b><span id="monday_total_remaining_display" style="color:#f0ad4e"><span id="monday_total_remaining"></span> meals</span></b>)
                            </div>
                            <div class="row padder">
                              Choose your meals by <%= @cut_off_date.strftime("%A %B %e") %> at <%= @cut_off_date.wday == 0 ? '2pm' : 'midnight' %>. If no selection is made before the cut off then default selection will be sent
                            </div>
                            <div class="row m-t-none">
                              <div class="col-lg-2 col-md-2 col-sm-5 col-xs-5 m-l-md m-t-sm meal_card beef">
                                <div class="inner">
                                  <div class="row text-center" style="padding: 5px; height: 70%; width:100%; background-color:white; margin-left: 0;">
                                    <h5 style="color:#555;"><%= @monday_beef_selection_1_name %></h5>
                                    <p style="color:#555; font-size: 12px;"><%= @monday_beef_selection_1_sub_name %></p>
                                  </div>
                                  <div class="row display_number_container" style="height: 30%; width:100%; margin-left: 0;">
                                    <div class="col-md-12 text-center text-muted m-t-n-md container" style="width:100%;">
                                      <div class="row">
                                          <span class="h1 block selection_display" id="monday_beef_1" style="font-size:30px;"><%= @monday_beef_selection_1_number %></span>
                                      </div>
                                      <div class="row row-centered">
                                        <div class="col-md-12" style="float:none;margin-top: -48px; padding:7px;">
                                          <input type="text" id="monday_beef_1_spinner" value="<%= @monday_beef_selection_1_number %>" style="opacity: 0;">
                                        </div>
                                      </div>
                                    </div>                                    
                                  </div>
                                </div>
                              </div>
                              <div class="col-lg-2 col-md-2 col-sm-5 col-xs-5 m-l-md m-t-sm meal_card pork">
                                <div class="inner">
                                  <div class="row text-center" style="padding: 5px; height: 70%; width:100%; background-color:white; margin-left: 0;">
                                    <h5 style="color:#555;"><%= @monday_pork_selection_1_name %></h5>
                                    <p style="color:#555; font-size: 12px;"><%= @monday_pork_selection_1_sub_name %></p>
                                  </div>
                                  <div class="row display_number_container" style="height: 30%; width:100%; margin-left: 0;">
                                    <div class="col-md-12 text-center text-muted m-t-n-md container" style="width:100%;">
                                      <div class="row">
                                          <span class="h1 block selection_display" id="monday_pork_1" style="font-size:30px;"><%= @monday_pork_selection_1_number %></span>
                                      </div>
                                      <div class="row row-centered">
                                        <div class="col-md-12" style="float:none;margin-top: -48px; padding:7px;">
                                          <input type="text" id="monday_pork_1_spinner" value="<%= @monday_pork_selection_1_number %>" style="opacity: 0;">
                                        </div>
                                      </div>
                                    </div>                                    
                                  </div>                                
                                </div>
                              </div>
                              <div class="col-lg-2 col-md-2 col-sm-5 col-xs-5 m-l-md m-t-sm meal_card poultry">
                                <div class="inner">
                                  <div class="row text-center" style="padding: 5px; height: 70%; width:100%; background-color:white; margin-left: 0;">
                                    <h5 style="color:#555;"><%= @monday_poultry_selection_1_name %></h5>
                                    <p style="color:#555; font-size: 12px;"><%= @monday_poultry_selection_1_sub_name %></p>
                                  </div>
                                  <div class="row display_number_container" style="height: 30%; width:100%; margin-left: 0;">
                                    <div class="col-md-12 text-center text-muted m-t-n-md container" style="width:100%;">
                                      <div class="row">
                                          <span class="h1 block selection_display" id="monday_poultry_1" style="font-size:30px;"><%= @monday_poultry_selection_1_number %></span>
                                      </div>
                                      <div class="row row-centered">
                                        <div class="col-md-12" style="float:none;margin-top: -48px; padding:7px;">
                                          <input type="text" id="monday_poultry_1_spinner" value="<%= @monday_poultry_selection_1_number %>" style="opacity: 0;">
                                        </div>
                                      </div>
                                    </div>                                    
                                  </div>                                 
                                </div>
                              </div>
                              <div class="col-lg-2 col-md-2 col-sm-5 col-xs-5 m-l-md m-t-sm meal_card green_1">
                                <div class="inner">
                                  <div class="row text-center" style="padding: 5px; height: 70%; width:100%; background-color:white; margin-left: 0;">
                                    <h5 style="color:#555;"><%= @monday_green_1_selection_1_name %></h5>
                                    <p style="color:#555; font-size: 12px;"><%= @monday_green_1_selection_1_sub_name %></p>
                                  </div>
                                  <div class="row  display_number_container" style="height: 30%; width:100%; margin-left: 0;">
                                    <div class="col-md-12 text-center text-muted m-t-n-md container" style="width:100%;">
                                      <div class="row">
                                          <span class="h1 block selection_display" id="monday_green_1_1" style="font-size:30px;color:#5cb85c;"><%= @monday_green_1_selection_1_number %></span>
                                      </div>
                                      <div class="row row-centered">
                                        <div class="col-md-12" style="float:none;margin-top: -48px; padding:7px;">
                                          <input type="text" id="monday_green_1_1_spinner" value="<%= @monday_green_1_selection_1_number %>" style="opacity: 0;">
                                        </div>
                                      </div>
                                    </div>                                    
                                  </div>                                 
                                </div>
                              </div>
                              <div class="col-lg-2 col-md-2 col-sm-5 col-xs-5 m-l-md m-t-sm meal_card green_2">
                                <div class="inner">
                                  <div class="row text-center" style="padding: 5px; height: 70%; width:100%; background-color:white; margin-left: 0;">
                                    <h5 style="color:#555;"><%= @monday_green_2_selection_1_name %></h5>
                                    <p style="color:#555; font-size: 12px;"><%= @monday_green_2_selection_1_sub_name %></p>
                                  </div>
                                  <div class="row display_number_container" style="height: 30%; width:100%; margin-left: 0;">
                                    <div class="col-md-12 text-center text-muted m-t-n-md container" style="width:100%;">
                                      <div class="row">
                                          <span class="h1 block selection_display" id="monday_green_2_1" style="font-size:30px; color:#5cb85c;"><%= @monday_green_2_selection_1_number %></span>
                                      </div>
                                      <div class="row row-centered">
                                        <div class="col-md-12" style="float:none;margin-top: -48px; padding:7px;">
                                          <input type="text" id="monday_green_2_1_spinner" value="<%= @monday_green_2_selection_1_number %>" style="opacity: 0;">
                                        </div>
                                      </div>
                                    </div>                                    
                                  </div>                                 
                                </div>
                              </div>
                            </div>
                            <div class="row m-t-lg padder">
                              Meal selection for <b style="font-size:15px;"><%= (@display_production_day_2 + 1.day).strftime("%A %B %e") %></b> (Meals remaining: <span id="thursday_selection_full">none. You have selected all your meals! You can add more meals in <a href="#changePlan" data-toggle="tab" class="url_seg">Manage Subscription</a> tab</span><b><span id="thursday_total_remaining_display" style="color:#f0ad4e"><span id="thursday_total_remaining"></span> meals</span></b>)
                            </div>
                            <div class="row padder">
                              Choose your meals by <%= @cut_off_date.strftime("%A %B %e") %> at <%= @cut_off_date.wday == 0 ? '2pm' : 'midnight' %>. If no selection is made before the cut off then default selection will be sent.
                            </div>
                            <div class="row m-t-none">
                              <div class="col-lg-2 col-md-2 col-sm-5 col-xs-5 m-l-md m-t-sm meal_card beef">
                                <div class="inner">
                                  <div class="row text-center" style="padding: 5px; height: 70%; width:100%; background-color:white; margin-left: 0;">
                                    <h5 style="color:#555;"><%= @thursday_beef_selection_1_name %></h5>
                                    <p style="color:#555; font-size: 12px;"><%= @thursday_beef_selection_1_sub_name %></p>
                                  </div>
                                  <div class="row display_number_container" style="height: 30%; width:100%; margin-left: 0;">
                                    <div class="col-md-12 text-center text-muted m-t-n-md container" style="width:100%;">
                                      <div class="row">
                                          <span class="h1 block selection_display" id="thursday_beef_1" style="font-size:30px;"><%= @thursday_beef_selection_1_number %></span>
                                      </div>
                                      <div class="row row-centered">
                                        <div class="col-md-12" style="float:none;margin-top: -48px; padding:7px;">
                                          <input type="text" id="thursday_beef_1_spinner" value="<%= @thursday_beef_selection_1_number %>" style="opacity: 0;">
                                        </div>
                                      </div>
                                    </div>                                    
                                  </div>
                                </div>
                              </div>
                              <div class="col-lg-2 col-md-2 col-sm-5 col-xs-5 m-l-md m-t-sm meal_card pork">
                                <div class="inner">
                                  <div class="row text-center" style="padding: 5px; height: 70%; width:100%; background-color:white; margin-left: 0;">
                                    <h5 style="color:#555;"><%= @thursday_pork_selection_1_name %></h5>
                                    <p style="color:#555; font-size: 12px;"><%= @thursday_pork_selection_1_sub_name %></p>
                                  </div>
                                  <div class="row display_number_container" style="height: 30%; width:100%; margin-left: 0;">
                                    <div class="col-md-12 text-center text-muted m-t-n-md container" style="width:100%;">
                                      <div class="row">
                                          <span class="h1 block selection_display" id="thursday_pork_1" style="font-size:30px;"><%= @thursday_pork_selection_1_number %></span>
                                      </div>
                                      <div class="row row-centered">
                                        <div class="col-md-12" style="float:none;margin-top: -48px; padding:7px;">
                                          <input type="text" id="thursday_pork_1_spinner" value="<%= @thursday_pork_selection_1_number %>" style="opacity: 0;">
                                        </div>
                                      </div>
                                    </div>                                    
                                  </div>                                
                                </div>
                              </div>
                              <div class="col-lg-2 col-md-2 col-sm-5 col-xs-5 m-l-md m-t-sm meal_card poultry">
                                <div class="inner">
                                  <div class="row text-center" style="padding: 5px; height: 70%; width:100%; background-color:white; margin-left: 0;">
                                    <h5 style="color:#555;"><%= @thursday_poultry_selection_1_name %></h5>
                                    <p style="color:#555; font-size: 12px;"><%= @thursday_poultry_selection_1_sub_name %></p>
                                  </div>
                                  <div class="row display_number_container" style="height: 30%; width:100%; margin-left: 0;">
                                    <div class="col-md-12 text-center text-muted m-t-n-md container" style="width:100%;">
                                      <div class="row">
                                          <span class="h1 block selection_display" id="thursday_poultry_1" style="font-size:30px;"><%= @thursday_poultry_selection_1_number %></span>
                                      </div>
                                      <div class="row row-centered">
                                        <div class="col-md-12" style="float:none;margin-top: -48px; padding:7px;">
                                          <input type="text" id="thursday_poultry_1_spinner" value="<%= @thursday_poultry_selection_1_number %>" style="opacity: 0;">
                                        </div>
                                      </div>
                                    </div>                                    
                                  </div>                                 
                                </div>
                              </div>
                              <div class="col-lg-2 col-md-2 col-sm-5 col-xs-5 m-l-md m-t-sm meal_card green_1">
                                <div class="inner">
                                  <div class="row text-center" style="padding: 5px; height: 70%; width:100%; background-color:white; margin-left: 0;">
                                    <h5 style="color:#555;"><%= @thursday_green_1_selection_1_name %></h5>
                                    <p style="color:#555; font-size: 12px;"><%= @thursday_green_1_selection_1_sub_name %></p>
                                  </div>
                                  <div class="row display_number_container" style="height: 30%; width:100%; margin-left: 0;">
                                    <div class="col-md-12 text-center text-muted m-t-n-md container" style="width:100%;">
                                      <div class="row">
                                          <span class="h1 block selection_display" id="thursday_green_1_1" style="font-size:30px;color:#5cb85c;"><%= @thursday_green_1_selection_1_number %></span>
                                      </div>
                                      <div class="row row-centered">
                                        <div class="col-md-12" style="float:none;margin-top: -48px; padding:7px;">
                                          <input type="text" id="thursday_green_1_1_spinner" value="<%= @thursday_green_1_selection_1_number %>" style="opacity: 0;">
                                        </div>
                                      </div>
                                    </div>                                    
                                  </div>                                 
                                </div>
                              </div>
                              <div class="col-lg-2 col-md-2 col-sm-5 col-xs-5 m-l-md m-t-sm meal_card green_2">
                                <div class="inner">
                                  <div class="row text-center" style="padding: 5px; height: 70%; width:100%; background-color:white; margin-left: 0;">
                                    <h5 style="color:#555;"><%= @thursday_green_2_selection_1_name %></h5>
                                    <p style="color:#555; font-size: 12px;"><%= @thursday_green_2_selection_1_sub_name %></p>
                                  </div>
                                  <div class="row display_number_container" style="height: 30%; width:100%; margin-left: 0;">
                                    <div class="col-md-12 text-center text-muted m-t-n-md container" style="width:100%;">
                                      <div class="row">
                                          <span class="h1 block selection_display" id="thursday_green_2_1" style="font-size:30px;color:#5cb85c;"><%= @thursday_green_2_selection_1_number %></span>
                                      </div>
                                      <div class="row row-centered">
                                        <div class="col-md-12" style="float:none;margin-top: -48px; padding:7px;">
                                          <input type="text" id="thursday_green_2_1_spinner" value="<%= @thursday_green_2_selection_1_number %>" style="opacity: 0;">
                                        </div>
                                      </div>
                                    </div>                                    
                                  </div>                                 
                                </div>
                              </div>
                            </div>
                          </section>
                        </section>                      
                      </section> 

          
                      <% if @display_marketplace_to_customers %>
                        <section class="tab-pane" id="partner_product_selection" role="tabpanel">
                          <section class="vbox">
                            <section class="scrollable padder"> 
                              <section id="pagination_section_wrapper">
                                <div class="row m-b-md" >
                                  <div class="col-l-md-12" style="width:100%">
                                    <div style="background-image:url('https://s3.amazonaws.com/toronto-chowdy/marketplace-banner.jpg'); background-size:contain; background-repeat:no-repeat; width:100%; padding-bottom:17%;">
                                    <a href="<%= view_orders_path %>" class="pull-right" id="view_order_history" style="color:white; font-weight: bold; margin-right:20px; margin-top:10px;">View Order History</a>

                                    <a href="<%= marketplace_intro_path %>" class="pull-right pull_modal" style="color:white; font-weight: bold; margin-right:20px; margin-top:10px;">Intro to Marketplace</a>

                                      <div class="row padder">
                                        <div class="alert alert-success hidden" style="margin-bottom:0 !important;font-size: 18px;" id="partner_product_success_alert">
                                        </div>
                                      </div> 
                                    </div>
                                  </div>
                                </div>
                                <div class="row padder m-t-none">
                                    <% @parter_products.each do |pp| %>
                                      <div class="col-lg-2 col-md-2 col-sm-5 col-xs-5 m-l-none m-b-sm m-r-md hovereffect" style="width:300px; height: 200px; padding:0; border-radius:5px; overflow:hidden; z-index:2;">
                                          <img class="img-responsive" src="<%= pp.photos[0].thumb.url if pp.photos[0] %>" alt="" style=" width:300px;max-width:300px;">
                                          <div class="overlay">
                                             <h2 style="text-transform:none;"><%= pp.product_name %></h2>
                                             <section class="info">
                                                <section class="content">
                                                  <p>by <%= pp.vendor.vendor_name %> ($<%= (pp.price_in_cents.to_f / 100).round(2).to_s %> + HST)</p>
                                                  <p><%= pp.product_description[0...60] + (pp.product_description.length > 60 ? "..." : "") %> <a class="pull_modal" href="<%= partner_product_path(pp) %>">more</a></p>
                                                  <form class="add_to_cart" data-product-id="<%= pp.id %>" style="color:black">
                                                    <div class="form-group">
                                                      <input type="number" class="qty" data-product-id="<%= pp.id %>" required="true" placeholder="Qty" min="0" style="width:60px;height:32px; float:left; margin-left: 32px; margin-right: 10px; border:1px solid white; text-align: center;" <% if @disable_markplace_purchase %>disabled="disabled"<% end %>>
                                                    </div>
                                                    <input type="submit" class="btn btn-s-md btn-default" style="float:left; border: none; border-radius: 0px; color:white !important; background-color:#f0ad4e;" value="Add to Cart" <% if @disable_markplace_purchase %>disabled="disabled"<% end %>>
                                                  </form>
                                                </section>
                                             </section>
                                          </div>
                                      </div>
                                    <% end %>
                                </div>
                                <div class="row padder m-t-none">
                                  <%= paginate Kaminari.paginate_array(PartnerProduct.products_to_display).page, params: {controller: :partner_products, action: :paginate} %>
                                </div>
                              </section>
                              <div class="row m-t-lg padder">
                                <div class="well col-lg-5">
                                  <span><b>Total amount: $<span id="partner_product_total_dollar">0.00</span> (including HST)</b></span>
                                  <br>
                                    <button class="btn btn-s-md btn-success m-t-sm disabled" id="submit_partner_product_selection">View Cart and Checkout</button>
                                    <br>
                                    <span class="m-t-sm" style="display:block;">Order will be delivered on <%= @marketplace_delivery_date %></span>                            
                                </div>
                              </div>
                            </section>
                          </section>                      
                        </section> 

                        <section class="tab-pane" id="view_orders" role="tabpanel">
                          <section class="vbox">
                            <section class="scrollable padder"> 
                              <div class="row padder">
                                <div class="alert alert-success hidden" style="margin-bottom:0 !important;font-size: 18px;" id="marketplace_view_order_alert">
                                </div>
                              </div> 
                              <div class="row padder padder-v">
                                <div class="col-sm-12" id="order_history_table_container">
                                  
                                </div>
                              </div>
                            </section>
                          </section>
                        </section>
                      <% end %>
                    <% end %> 

                </section>
            </section>
        
        </section>
    </section>
</section>

<!-- Pause modal -->
<div class="modal fade" id="pauseModal" tabindex="-1" role="dialog" aria-labelledby="pauseModal" aria-hidden="true" style="z-index: 10000;">
  <div class="modal-dialog">
    <%= form_tag update_customer_path("pause"), method: 'POST', role:"form" do %>
      <div class="modal-content">
        <div class="modal-header">
          <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
          <h4 class="modal-title" id="myModalLabel">Choose your pause start date and resume date - weekly cutoff is end of day every Thursday</h4>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <%= label_tag 'pause_date_start_picker', "Select the pause start date" %>
            <%= text_field_tag 'pause_date_start_picker',nil,class: "input-sm input-s form-control datepicker-input readonly", size: "16", data: {date_format: "yyyy-mm-dd"}%>
          </div>
          <div class="form-group">
            <%= label_tag 'pause_date_picker', "Select a resume date" %>
            <%= text_field_tag 'pause_date_picker',nil,class: "input-sm input-s form-control datepicker-input readonly", size: "16", data: {date_format: "yyyy-mm-dd"}%>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          <%= submit_tag 'Pause Subscription', class:"btn btn-primary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Cancel modal -->
<div class="modal fade" id="cancelModal" tabindex="-1" role="dialog" aria-labelledby="cancelModal" aria-hidden="true" style="z-index: 10000;">
  <div class="modal-dialog">
      <div class="modal-content">
        <%= form_tag update_customer_path("cancel"), method: 'POST', id:"cancel_form" do %>
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Can you let us know the reason for cancellation?</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <%= label_tag 'cancel_reason', "Reason for cancellation" %>
              <%= select_tag "cancel_reason", options_for_select(@cancel_reasons), include_blank: true, class:"chosen-select", data: {placeholder: "Choose one"} %>
              <script>
                $(".chosen-select").chosen({
                  width: "75%",
                  disable_search: true
                }).off("change").on("change",function(){
                  $("#cancel_form input[type=submit]").removeClass("disabled");
                })
              </script>
            </div>
            <div class="form-group">
              <%= label_tag 'feedback', "Other comments" %>
              <%= text_area_tag 'feedback',nil,class: "input-sm input-s form-control", rows: "6", placeholder: "Type your comments" %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <%= submit_tag 'Confirm cancellation',class:"btn btn-primary disabled" %>
          </div>
        <% end %>
      </div>
  </div>
</div>

<!-- Feedback modal -->
<div class="modal fade" id="feedbackModal" tabindex="-1" role="dialog" aria-labelledby="cancelModal" aria-hidden="true" style="z-index: 10000;">
  <div class="modal-dialog">
      <div class="modal-content">
        <%= form_tag update_customer_path("feedback"), method: 'POST' do %>
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Feedback</h4>
          </div>
          <div class="modal-body">
            <div class="form-group">
              <p><b>Submit feedback to help improve Chowdy (for immediate assistance, please email <a href='mailto:help@chowdy'>help@chowdy.ca</a>)</b></p>
              <%= text_area_tag 'feedback',nil,class: "input-sm input-s form-control", rows: "6", placeholder: "Type your comments" %>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <%= submit_tag 'Submit feedback',class:"btn btn-primary" %>
          </div>
        <% end %>
      </div>
  </div>
</div>

<!-- General modal -->
<div class="modal fade" id="generalModal" tabindex="-1" role="dialog" aria-labelledby="cancelModal" aria-hidden="true" style="z-index: 10000;">
  <div class="modal-dialog">
      <div class="modal-content">
      </div>
  </div>
</div>


<!-- Error modal -->
<div class="modal fade" id="errorModal" tabindex="-1" role="dialog" aria-labelledby="errorModal" aria-hidden="true" style="z-index: 10000;">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Error</h4>
          </div>
          <div class="modal-body">

          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
          </div>
      </div>
  </div>
</div>

<!-- Partner product cart modal -->
<div class="modal fade" id="partner_product_cart_modal" tabindex="-1" role="dialog" aria-labelledby="partner_product_cart_modal" aria-hidden="true" style="z-index: 10000;">
  <div class="modal-dialog">
      <div class="modal-content">
          <div class="modal-header">
            <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
            <h4 class="modal-title" id="myModalLabel">Marketplace Cart (Delivery on <%= @marketplace_delivery_date %>)</h4>
          </div>
          <div class="modal-body">
            <table class="table" id="partner_products_checkout_summary" style="font-size:12px;">
              <thead>
                <th>QTY</th>
                <th>PRODUCT</th>
                <th>UNIT PRICE</th>
                <th>TOTAL</th>
              </thead>
              <tbody>
                
              </tbody>
            </table>
          <div class="alert hidden" id="partner_product_purchase_alert" style="margin-bottom:0 !important;"></div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
            <button type="button" class="btn btn-success disabled" id="place_order" href="<%= order_partner_product_path %>">Order</button>
          </div>
      </div>
  </div>
</div>
